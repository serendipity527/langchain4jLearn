# æ–‡æ¡£åˆ†å‰²å™¨è®¾è®¡æ¨¡å¼è¯´æ˜

## é‡æ„æ¦‚è¿°

ä½¿ç”¨**ç­–ç•¥æ¨¡å¼**å’Œ**å·¥å‚æ¨¡å¼**å®ç°æ–‡æ¡£åˆ†å‰²å™¨åŠŸèƒ½ï¼Œæä¾›å¤šç§åˆ†å‰²ç­–ç•¥ä¾›ç”¨æˆ·åŠ¨æ€é€‰æ‹©ï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯é…ç½®æ€§ã€‚

---

## è®¾è®¡æ¨¡å¼åº”ç”¨

### ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**ç›®çš„**: å®šä¹‰ä¸€ç³»åˆ—åˆ†å‰²ç®—æ³•ï¼ŒæŠŠå®ƒä»¬å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚

**å®ç°**:
- **ç­–ç•¥æ¥å£**: `DocumentSplitterStrategy`
- **å…·ä½“ç­–ç•¥**:
  - `RecursiveDocumentSplitterStrategy` - é€’å½’åˆ†å‰²ï¼ˆæ¨èï¼‰
  - `ParagraphDocumentSplitterStrategy` - æŒ‰æ®µè½åˆ†å‰²
  - `SentenceDocumentSplitterStrategy` - æŒ‰å¥å­åˆ†å‰²
  - `CharacterDocumentSplitterStrategy` - æŒ‰å­—ç¬¦åˆ†å‰²

### å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

**å®ç°**:
- **å·¥å‚ç±»**: `DocumentSplitterFactory`
- **åŠŸèƒ½**: æ ¹æ® `DocumentSplitterType` æšä¸¾è¿”å›å¯¹åº”çš„åˆ†å‰²å™¨ç­–ç•¥

---

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         RagController                    â”‚
â”‚  (æä¾›åˆ†å‰²å™¨é€‰æ‹©API)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        DocumentService                   â”‚
â”‚  (ä½¿ç”¨åˆ†å‰²å™¨å·¥å‚å¤„ç†æ–‡æ¡£)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    DocumentSplitterFactory â­            â”‚
â”‚    (åˆ†å‰²å™¨å·¥å‚ - åŠ¨æ€é€‰æ‹©)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Recursive â”‚     â”‚Paragraph â”‚
â”‚Splitter  â”‚     â”‚Splitter  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Sentence  â”‚     â”‚Character â”‚
â”‚Splitter  â”‚     â”‚Splitter  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç±»è¯´æ˜

### 1. DocumentSplitterTypeï¼ˆæšä¸¾ï¼‰

```java
public enum DocumentSplitterType {
    BY_PARAGRAPH,    // æŒ‰æ®µè½åˆ†å‰²
    BY_LINE,         // æŒ‰è¡Œåˆ†å‰²
    BY_SENTENCE,     // æŒ‰å¥å­åˆ†å‰²
    BY_WORD,         // æŒ‰å•è¯åˆ†å‰²
    BY_CHARACTER,    // æŒ‰å­—ç¬¦åˆ†å‰²
    BY_REGEX,        // æŒ‰æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰²
    RECURSIVE        // é€’å½’åˆ†å‰²ï¼ˆæ¨èï¼‰
}
```

---

### 2. DocumentSplitterStrategyï¼ˆç­–ç•¥æ¥å£ï¼‰

```java
public interface DocumentSplitterStrategy {
    // åˆ†å‰²å•ä¸ªæ–‡æ¡£
    List<TextSegment> split(Document document);
    
    // æ‰¹é‡åˆ†å‰²å¤šä¸ªæ–‡æ¡£
    List<TextSegment> splitAll(List<Document> documents);
    
    // è·å–åˆ†å‰²å™¨ç±»å‹
    DocumentSplitterType getSplitterType();
    
    // è·å–åˆ†å‰²å™¨å®ä¾‹
    DocumentSplitter getSplitterInstance();
    
    // è·å–é…ç½®æè¿°
    String getDescription();
}
```

---

### 3. å…·ä½“åˆ†å‰²å™¨ç­–ç•¥

#### RecursiveDocumentSplitterStrategyï¼ˆæ¨èï¼‰

**ç‰¹ç‚¹**:
- âœ… æ™ºèƒ½åˆ†å‰²ï¼šä¼˜å…ˆæŒ‰æ®µè½ã€å¥å­ç­‰è‡ªç„¶è¾¹ç•Œåˆ†å‰²
- âœ… å¯é…ç½®ï¼šæ”¯æŒè‡ªå®šä¹‰å—å¤§å°å’Œé‡å å¤§å°
- âœ… é€šç”¨æ€§å¼ºï¼šé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯

**é…ç½®**:
```java
@Value("${document.splitter.max-segment-size:300}")
private int maxSegmentSize;

@Value("${document.splitter.max-overlap-size:50}")
private int maxOverlapSize;
```

**ä½¿ç”¨åœºæ™¯**:
- é€šç”¨æ–‡æ¡£å¤„ç†
- éœ€è¦ä¿æŒè¯­ä¹‰å®Œæ•´æ€§
- é»˜è®¤é€‰æ‹©

---

#### ParagraphDocumentSplitterStrategy

**ç‰¹ç‚¹**:
- æŒ‰æ®µè½è¾¹ç•Œåˆ†å‰²
- ä¿æŒæ®µè½å®Œæ•´æ€§
- é€‚åˆç»“æ„åŒ–æ–‡æ¡£

**ä½¿ç”¨åœºæ™¯**:
- æ–‡ç« ã€æŠ¥å‘Šç­‰ç»“æ„åŒ–æ–‡æ¡£
- éœ€è¦ä¿æŒæ®µè½è¯­ä¹‰

---

#### SentenceDocumentSplitterStrategy

**ç‰¹ç‚¹**:
- æŒ‰å¥å­è¾¹ç•Œåˆ†å‰²
- ä¿æŒå¥å­å®Œæ•´æ€§
- ç²’åº¦é€‚ä¸­

**ä½¿ç”¨åœºæ™¯**:
- é—®ç­”ç³»ç»Ÿ
- éœ€è¦ç²¾ç¡®çš„è¯­ä¹‰å•å…ƒ

---

#### CharacterDocumentSplitterStrategy

**ç‰¹ç‚¹**:
- æŒ‰å›ºå®šå­—ç¬¦æ•°åˆ†å‰²
- ä¸è€ƒè™‘è¯­ä¹‰è¾¹ç•Œ
- ç²¾ç¡®æ§åˆ¶å—å¤§å°

**ä½¿ç”¨åœºæ™¯**:
- éœ€è¦ç²¾ç¡®æ§åˆ¶tokenæ•°é‡
- å¯¹å¤§å°æœ‰ä¸¥æ ¼é™åˆ¶

---

### 4. DocumentSplitterFactoryï¼ˆå·¥å‚ç±»ï¼‰

```java
@Component
@RequiredArgsConstructor
public class DocumentSplitterFactory {
    private final List<DocumentSplitterStrategy> splitterStrategies;
    
    // æ ¹æ®ç±»å‹è·å–åˆ†å‰²å™¨
    public DocumentSplitterStrategy getSplitter(DocumentSplitterType splitterType);
    
    // è·å–é»˜è®¤åˆ†å‰²å™¨ï¼ˆé€’å½’åˆ†å‰²å™¨ï¼‰
    public DocumentSplitterStrategy getDefaultSplitter();
    
    // åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„åˆ†å‰²å™¨
    public Map<DocumentSplitterType, String> listAvailableSplitters();
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… Springè‡ªåŠ¨æ³¨å…¥æ‰€æœ‰åˆ†å‰²å™¨ç­–ç•¥
- âœ… æä¾›é»˜è®¤åˆ†å‰²å™¨ï¼ˆé€’å½’ï¼‰
- âœ… æ”¯æŒæŸ¥è¯¢æ‰€æœ‰å¯ç”¨åˆ†å‰²å™¨

---

## é…ç½®è¯´æ˜

### application.properties

```properties
# æ–‡æ¡£åˆ†å‰²å™¨é…ç½®
# æ¯ä¸ªæ–‡æœ¬å—çš„æœ€å¤§å­—ç¬¦æ•°
document.splitter.max-segment-size=300
# æ–‡æœ¬å—ä¹‹é—´çš„é‡å å­—ç¬¦æ•°
document.splitter.max-overlap-size=50
```

**å‚æ•°è¯´æ˜**:
- `max-segment-size`: æ¯ä¸ªæ–‡æœ¬å—çš„æœ€å¤§å­—ç¬¦æ•°
  - æ¨èå€¼: 200-500
  - è¿‡å°: è¯­ä¹‰ä¸å®Œæ•´
  - è¿‡å¤§: æ£€ç´¢ä¸ç²¾ç¡®

- `max-overlap-size`: æ–‡æœ¬å—ä¹‹é—´çš„é‡å å­—ç¬¦æ•°
  - æ¨èå€¼: segment-size çš„ 10-20%
  - ä½œç”¨: é¿å…é‡è¦ä¿¡æ¯åœ¨åˆ†å‰²è¾¹ç•Œå¤„ä¸¢å¤±

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. ä½¿ç”¨é»˜è®¤åˆ†å‰²å™¨

```java
// è‡ªåŠ¨ä½¿ç”¨é€’å½’åˆ†å‰²å™¨
documentService.ingestDocumentFromFile("C:/docs/report.pdf");
```

### 2. æŒ‡å®šåˆ†å‰²å™¨ç±»å‹

```java
// ä½¿ç”¨æ®µè½åˆ†å‰²å™¨
documentService.ingestDocuments(documents, DocumentSplitterType.BY_PARAGRAPH);

// ä½¿ç”¨å¥å­åˆ†å‰²å™¨
documentService.ingestDocuments(documents, DocumentSplitterType.BY_SENTENCE);
```

### 3. åŠ¨æ€é€‰æ‹©åŠ è½½å™¨å’Œåˆ†å‰²å™¨

```java
documentService.ingestDocumentWithCustomSplitter(
    DocumentLoaderType.FILE_SYSTEM,
    "C:/docs/example.pdf",
    DocumentSplitterType.RECURSIVE
);
```

### 4. é€šè¿‡APIä½¿ç”¨

#### è·å–å¯ç”¨åˆ†å‰²å™¨åˆ—è¡¨
```bash
curl -X GET http://localhost:8080/api/rag/splitters
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "RECURSIVE": "é€’å½’åˆ†å‰²å™¨ (æ™ºèƒ½åˆ†å‰², å—å¤§å°: 300, é‡å : 50)",
  "BY_PARAGRAPH": "æ®µè½åˆ†å‰²å™¨ (æŒ‰æ®µè½åˆ†å‰², å—å¤§å°: 500, é‡å : 50)",
  "BY_SENTENCE": "å¥å­åˆ†å‰²å™¨ (æŒ‰å¥å­åˆ†å‰², å—å¤§å°: 300, é‡å : 30)",
  "BY_CHARACTER": "å­—ç¬¦åˆ†å‰²å™¨ (æŒ‰å­—ç¬¦æ•°åˆ†å‰², å—å¤§å°: 200, é‡å : 20)"
}
```

#### ä½¿ç”¨è‡ªå®šä¹‰åˆ†å‰²å™¨æ‘„å–æ–‡æ¡£
```bash
curl -X POST http://localhost:8080/api/rag/ingest-with-splitter \
  -H "Content-Type: application/json" \
  -d '{
    "loaderType": "FILE_SYSTEM",
    "sourcePath": "C:/docs/report.pdf",
    "splitterType": "BY_PARAGRAPH"
  }'
```

---

## åˆ†å‰²å™¨å¯¹æ¯”

| åˆ†å‰²å™¨ç±»å‹ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|----------|------|------|---------|
| **RECURSIVE** | æ™ºèƒ½åˆ†å‰²ï¼Œä¿æŒè¯­ä¹‰å®Œæ•´ | - | é€šç”¨åœºæ™¯ï¼ˆæ¨èï¼‰ |
| **BY_PARAGRAPH** | ä¿æŒæ®µè½å®Œæ•´æ€§ | æ®µè½è¿‡é•¿æ—¶å•ä¸ªå—å¯èƒ½è¿‡å¤§ | ç»“æ„åŒ–æ–‡æ¡£ |
| **BY_SENTENCE** | ä¿æŒå¥å­å®Œæ•´æ€§ | å¯èƒ½äº§ç”Ÿè¾ƒå°çš„å— | é—®ç­”ç³»ç»Ÿ |
| **BY_CHARACTER** | ç²¾ç¡®æ§åˆ¶å¤§å° | å¯èƒ½ç ´åè¯­ä¹‰ | ä¸¥æ ¼å¤§å°é™åˆ¶ |

---

## é‡æ„å‰åå¯¹æ¯”

### é‡æ„å‰ - DocumentService
```java
// ç¡¬ç¼–ç åˆ†å‰²å™¨é…ç½®
DocumentSplitter splitter = DocumentSplitters.recursive(300, 50);
```

### é‡æ„å - DocumentService
```java
// ä½¿ç”¨å·¥å‚åŠ¨æ€é€‰æ‹©åˆ†å‰²å™¨
DocumentSplitterStrategy splitterStrategy = splitterFactory.getSplitter(splitterType);
DocumentSplitter splitter = splitterStrategy.getSplitterInstance();
```

**æ”¹è¿›**:
- âœ… å¯é…ç½®ï¼šé€šè¿‡å‚æ•°åŠ¨æ€é€‰æ‹©
- âœ… å¯æ‰©å±•ï¼šæ·»åŠ æ–°åˆ†å‰²å™¨åªéœ€å®ç°æ¥å£
- âœ… å¯æµ‹è¯•ï¼šæ¯ä¸ªåˆ†å‰²å™¨ç‹¬ç«‹æµ‹è¯•

---

## æ‰©å±•æ–°çš„åˆ†å‰²å™¨

### ç¤ºä¾‹ï¼šæ·»åŠ æŒ‰è¡Œåˆ†å‰²å™¨

#### æ­¥éª¤1: åˆ›å»ºç­–ç•¥å®ç°
```java
@Component
public class LineDocumentSplitterStrategy implements DocumentSplitterStrategy {
    
    private final DocumentSplitter splitter;
    
    public LineDocumentSplitterStrategy(
            @Value("${document.splitter.max-segment-size:300}") int maxSegmentSize,
            @Value("${document.splitter.max-overlap-size:20}") int maxOverlapSize) {
        this.splitter = new DocumentByLineSplitter(maxSegmentSize, maxOverlapSize);
    }
    
    @Override
    public DocumentSplitterType getSplitterType() {
        return DocumentSplitterType.BY_LINE;
    }
    
    // ... å…¶ä»–æ–¹æ³•å®ç°
}
```

#### æ­¥éª¤2: å®Œæˆï¼
- âœ… Spring è‡ªåŠ¨æ³¨å…¥
- âœ… å·¥å‚è‡ªåŠ¨è¯†åˆ«
- âœ… ç«‹å³å¯ç”¨

---

## å®Œæ•´æ¶æ„æ€»ç»“

```
ç”¨æˆ·è¯·æ±‚
    â†“
RagController
    â†“
DocumentService
    â†“
DocumentLoaderFactoryï¼ˆåŠ è½½å™¨å·¥å‚ï¼‰
    â†“
åŠ è½½æ–‡æ¡£
    â†“
DocumentSplitterFactoryï¼ˆåˆ†å‰²å™¨å·¥å‚ï¼‰â­
    â†“
æ™ºèƒ½é€‰æ‹©åˆ†å‰²å™¨ç­–ç•¥
    â†“
åˆ†å‰²æ–‡æ¡£
    â†“
å‘é‡åŒ–å­˜å‚¨
```

**ç‰¹ç‚¹**:
- ä¸‰å±‚ç­–ç•¥æ¨¡å¼ï¼ˆåŠ è½½å™¨ + è§£æå™¨ + åˆ†å‰²å™¨ï¼‰
- ä¸‰å±‚å·¥å‚æ¨¡å¼ï¼ˆåŠ è½½å™¨å·¥å‚ + è§£æå™¨å·¥å‚ + åˆ†å‰²å™¨å·¥å‚ï¼‰
- å®Œå…¨ç¬¦åˆSOLIDåŸåˆ™
- å·¥ä¸šçº§ä»£ç è®¾è®¡

---

## ä¼˜åŠ¿æ€»ç»“

### 1. **çµæ´»æ€§**
- âœ… æ”¯æŒå¤šç§åˆ†å‰²ç­–ç•¥
- âœ… è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©
- âœ… å¯é€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´å‚æ•°

### 2. **å¯æ‰©å±•æ€§**
- âœ… æ·»åŠ æ–°åˆ†å‰²å™¨åªéœ€å®ç°æ¥å£
- âœ… æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
- âœ… Springè‡ªåŠ¨æ³¨å…¥ç®¡ç†

### 3. **å¯ç»´æŠ¤æ€§**
- âœ… æ¯ä¸ªåˆ†å‰²å™¨ç‹¬ç«‹å®ç°
- âœ… èŒè´£æ¸…æ™°ï¼Œæ˜“äºç†è§£
- âœ… ä¾¿äºå•å…ƒæµ‹è¯•

### 4. **ä¸“ä¸šæ€§**
- âœ… éµå¾ªè®¾è®¡æ¨¡å¼æœ€ä½³å®è·µ
- âœ… ä»£ç ç»“æ„æ¸…æ™°ä¼˜é›…
- âœ… ç¬¦åˆä¼ä¸šçº§å¼€å‘æ ‡å‡†

---

## é¡¹ç›®ç»“æ„

```
src/main/java/org/example/ragtest/
â”œâ”€â”€ splitter/                        # æ–‡æ¡£åˆ†å‰²å™¨åŒ…ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ DocumentSplitterStrategy.java  # åˆ†å‰²å™¨ç­–ç•¥æ¥å£
â”‚   â”œâ”€â”€ DocumentSplitterType.java      # åˆ†å‰²å™¨ç±»å‹æšä¸¾
â”‚   â”œâ”€â”€ DocumentSplitterFactory.java   # åˆ†å‰²å™¨å·¥å‚
â”‚   â””â”€â”€ impl/                          # åˆ†å‰²å™¨ç­–ç•¥å®ç°
â”‚       â”œâ”€â”€ RecursiveDocumentSplitterStrategy.java
â”‚       â”œâ”€â”€ ParagraphDocumentSplitterStrategy.java
â”‚       â”œâ”€â”€ SentenceDocumentSplitterStrategy.java
â”‚       â””â”€â”€ CharacterDocumentSplitterStrategy.java
â”œâ”€â”€ loader/                          # æ–‡æ¡£åŠ è½½å™¨åŒ…
â”‚   â””â”€â”€ ...
â”œâ”€â”€ parser/                          # æ–‡æ¡£è§£æå™¨åŒ…
â”‚   â””â”€â”€ ...
â””â”€â”€ service/
    â””â”€â”€ DocumentService.java         # ä½¿ç”¨æ‰€æœ‰å·¥å‚
```

---

## æ€»ç»“

é€šè¿‡å¼•å…¥æ–‡æ¡£åˆ†å‰²å™¨çš„ç­–ç•¥æ¨¡å¼å’Œå·¥å‚æ¨¡å¼ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **å¤šç­–ç•¥æ”¯æŒ**: æä¾›4ç§å¸¸ç”¨åˆ†å‰²ç­–ç•¥
2. **åŠ¨æ€é€‰æ‹©**: è¿è¡Œæ—¶æ ¹æ®éœ€æ±‚é€‰æ‹©åˆ†å‰²å™¨
3. **æ˜“äºæ‰©å±•**: æ·»åŠ æ–°åˆ†å‰²å™¨åªéœ€å®ç°æ¥å£
4. **å‚æ•°åŒ–é…ç½®**: é€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´åˆ†å‰²å‚æ•°
5. **å®Œæ•´æ¶æ„**: å½¢æˆåŠ è½½å™¨â†’è§£æå™¨â†’åˆ†å‰²å™¨çš„å®Œæ•´å¤„ç†é“¾

è¿™æ˜¯ä¸€ä¸ªå±•ç¤º**è®¾è®¡æ¨¡å¼åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨**çš„ä¼˜ç§€æ¡ˆä¾‹ï¼ğŸ‰
