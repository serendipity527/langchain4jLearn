# å†…å®¹æ£€ç´¢å™¨è®¾è®¡æ¨¡å¼è¯´æ˜

## é‡æ„æ¦‚è¿°

ä½¿ç”¨**ç­–ç•¥æ¨¡å¼**å’Œ**å·¥å‚æ¨¡å¼**å®ç°å†…å®¹æ£€ç´¢å™¨ï¼ˆContentRetrieverï¼‰åŠŸèƒ½ï¼Œè¿™æ˜¯RAGç³»ç»Ÿçš„æ ¸å¿ƒæ£€ç´¢ç»„ä»¶ï¼Œè´Ÿè´£ä»å„ç§æ•°æ®æºæ£€ç´¢ç›¸å…³å†…å®¹ã€‚

---

## ä»€ä¹ˆæ˜¯ ContentRetrieverï¼Ÿ

### æ ¸å¿ƒæ¦‚å¿µ

**ContentRetriever** ä½¿ç”¨ç»™å®šçš„æŸ¥è¯¢ï¼ˆQueryï¼‰ä»åº•å±‚æ•°æ®æºæ£€ç´¢ç›¸å…³å†…å®¹ï¼ˆContentï¼‰ã€‚åº•å±‚æ•°æ®æºå¯ä»¥æ˜¯ï¼š

| æ•°æ®æºç±»å‹ | è¯´æ˜ | æœ¬é¡¹ç›®æ”¯æŒ |
|----------|------|-----------|
| **EmbeddingStore** | å‘é‡æ•°æ®åº“ï¼ŒåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢ | âœ… å·²å®ç° |
| **å…¨æ–‡æœç´¢å¼•æ“** | Elasticsearchã€Solrç­‰ | â³ å¯æ‰©å±• |
| **æ··åˆæœç´¢** | å‘é‡ + å…¨æ–‡æœç´¢ç»„åˆ | â³ å¯æ‰©å±• |
| **ç½‘ç»œæœç´¢å¼•æ“** | Googleã€Bingç­‰ | â³ å¯æ‰©å±• |
| **çŸ¥è¯†å›¾è°±** | Neo4jç­‰å›¾æ•°æ®åº“ | â³ å¯æ‰©å±• |
| **SQLæ•°æ®åº“** | å…³ç³»å‹æ•°æ®åº“ | â³ å¯æ‰©å±• |
| **Azure AI Search** | å¾®è½¯Azureæœç´¢æœåŠ¡ | â³ å¯æ‰©å±• |

### ContentRetriever çš„èŒè´£

```
æŸ¥è¯¢ï¼ˆQueryï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ContentRetriever            â”‚
â”‚  - ç†è§£æŸ¥è¯¢æ„å›¾                  â”‚
â”‚  - ä»æ•°æ®æºæ£€ç´¢ç›¸å…³å†…å®¹           â”‚
â”‚  - æŒ‰ç›¸å…³æ€§æ’åº                  â”‚
â”‚  - åº”ç”¨è¿‡æ»¤å™¨å’Œé˜ˆå€¼               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç›¸å…³å†…å®¹åˆ—è¡¨ï¼ˆContent[]ï¼‰
æŒ‰ç›¸å…³æ€§ä»é«˜åˆ°ä½æ’åº
```

---

## è®¾è®¡æ¨¡å¼åº”ç”¨

### ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**ç›®çš„**: å®šä¹‰ä¸€ç³»åˆ—æ£€ç´¢ç®—æ³•ï¼Œå°è£…æ¯ä¸ªç®—æ³•ï¼Œä½¿å®ƒä»¬å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚

**å®ç°**:
- **ç­–ç•¥æ¥å£**: `ContentRetrieverStrategy`
- **å…·ä½“ç­–ç•¥**:
  - `EmbeddingStoreContentRetrieverStrategy` - åŸºç¡€åµŒå…¥å¼å­˜å‚¨æ£€ç´¢
  - `AdvancedEmbeddingStoreRetrieverStrategy` - é«˜çº§åµŒå…¥å¼å­˜å‚¨æ£€ç´¢ï¼ˆæ”¯æŒåŠ¨æ€é…ç½®ï¼‰

### å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

**å®ç°**:
- **å·¥å‚ç±»**: `ContentRetrieverFactory`
- **åŠŸèƒ½**: 
  - æä¾›ä¸åŒç±»å‹çš„å†…å®¹æ£€ç´¢å™¨
  - æ£€æŸ¥æ£€ç´¢å™¨å¯ç”¨æ€§
  - ç®¡ç†æ£€ç´¢å™¨ç”Ÿå‘½å‘¨æœŸ

---

## æ ¸å¿ƒç±»è¯´æ˜

### 1. ContentRetrieverTypeï¼ˆæšä¸¾ï¼‰

```java
public enum ContentRetrieverType {
    EMBEDDING_STORE,      // åµŒå…¥å¼å­˜å‚¨æ£€ç´¢å™¨
    WEB_SEARCH,          // ç½‘ç»œæœç´¢æ£€ç´¢å™¨
    SQL_DATABASE,        // SQLæ•°æ®åº“æ£€ç´¢å™¨
    AZURE_AI_SEARCH,     // Azure AIæœç´¢æ£€ç´¢å™¨
    HYBRID               // æ··åˆæ£€ç´¢å™¨
}
```

---

### 2. ContentRetrieverStrategyï¼ˆç­–ç•¥æ¥å£ï¼‰

```java
public interface ContentRetrieverStrategy {
    // è·å– ContentRetriever å®ä¾‹
    ContentRetriever getRetriever();
    
    // è·å–æ£€ç´¢å™¨ç±»å‹
    ContentRetrieverType getRetrieverType();
    
    // è·å–æè¿°
    String getDescription();
    
    // æ˜¯å¦å¯ç”¨
    default boolean isEnabled() { return true; }
    
    // æœ€å¤§ç»“æœæ•°
    default int getMaxResults() { return 5; }
    
    // æœ€å°ç›¸å…³æ€§åˆ†æ•°
    default double getMinScore() { return 0.0; }
}
```

---

### 3. å…·ä½“æ£€ç´¢å™¨å®ç°

#### EmbeddingStoreContentRetrieverStrategyï¼ˆåŸºç¡€æ£€ç´¢å™¨ï¼‰

**ç‰¹ç‚¹**: ä» EmbeddingStore æ£€ç´¢å†…å®¹ï¼ŒåŸºäºå‘é‡ç›¸ä¼¼åº¦

**å®ç°**:
```java
@Component
@RequiredArgsConstructor
public class EmbeddingStoreContentRetrieverStrategy implements ContentRetrieverStrategy {
    
    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> embeddingStore;
    
    @Value("${rag.retrieval.max-results:5}")
    private int maxResults;
    
    @Value("${rag.retrieval.min-score:0.6}")
    private double minScore;
    
    @Override
    public ContentRetriever getRetriever() {
        return EmbeddingStoreContentRetriever.builder()
                .embeddingStore(embeddingStore)
                .embeddingModel(embeddingModel)
                .maxResults(maxResults)
                .minScore(minScore)
                .build();
    }
}
```

**é€‚ç”¨åœºæ™¯**:
- âœ… æ ‡å‡†çš„RAGæ£€ç´¢åœºæ™¯
- âœ… åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„å†…å®¹æ£€ç´¢
- âœ… ç§æœ‰çŸ¥è¯†åº“æ£€ç´¢

**å·¥ä½œæµç¨‹**:
```
ç”¨æˆ·æŸ¥è¯¢: "Spring Bootå¦‚ä½•é…ç½®æ•°æ®æºï¼Ÿ"
    â†“
1. EmbeddingModel å‘é‡åŒ–æŸ¥è¯¢
   [0.1, 0.3, -0.2, ...]
    â†“
2. EmbeddingStore æŸ¥æ‰¾ç›¸ä¼¼å‘é‡
   è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
    â†“
3. è¿”å› Top-K ç›¸å…³æ–‡æ¡£
   - æ–‡æ¡£1: åˆ†æ•° 0.85
   - æ–‡æ¡£2: åˆ†æ•° 0.78
   - æ–‡æ¡£3: åˆ†æ•° 0.72
    â†“
4. è¿‡æ»¤ä½äºé˜ˆå€¼çš„æ–‡æ¡£
   minScore = 0.6
    â†“
è¿”å›ç›¸å…³å†…å®¹åˆ—è¡¨
```

---

#### AdvancedEmbeddingStoreRetrieverStrategyï¼ˆé«˜çº§æ£€ç´¢å™¨ï¼‰â­

**ç‰¹ç‚¹**: æ”¯æŒåŠ¨æ€é…ç½®ï¼Œæ›´çµæ´»çš„æ£€ç´¢ç­–ç•¥

**å®ç°**:
```java
@Component
@Primary  // é»˜è®¤ä½¿ç”¨æ­¤å®ç°
@RequiredArgsConstructor
public class AdvancedEmbeddingStoreRetrieverStrategy implements ContentRetrieverStrategy {
    
    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> embeddingStore;
    
    @Value("${rag.retrieval.advanced.max-results:10}")
    private int maxResults;
    
    @Value("${rag.retrieval.advanced.min-score:0.5}")
    private double minScore;
    
    @Value("${rag.retrieval.dynamic.enabled:false}")
    private boolean dynamicEnabled;
    
    @Override
    public ContentRetriever getRetriever() {
        var builder = EmbeddingStoreContentRetriever.builder()
                .embeddingStore(embeddingStore)
                .embeddingModel(embeddingModel)
                .maxResults(maxResults)
                .minScore(minScore);
        
        if (dynamicEnabled) {
            // åŠ¨æ€æœ€å¤§ç»“æœæ•°
            builder.dynamicMaxResults(query -> {
                // æ ¹æ®æŸ¥è¯¢é•¿åº¦è°ƒæ•´ç»“æœæ•°
                return query.text().length() > 100 ? maxResults + 5 : maxResults;
            });
            
            // åŠ¨æ€æœ€å°åˆ†æ•°
            builder.dynamicMinScore(query -> minScore);
            
            // åŠ¨æ€è¿‡æ»¤å™¨
            builder.dynamicFilter(query -> {
                // æ ¹æ®æŸ¥è¯¢å‚æ•°åŠ¨æ€è¿‡æ»¤
                // ä¾‹å¦‚ï¼šæŒ‰ç”¨æˆ·æƒé™ã€æ–‡æ¡£ç±»å‹ç­‰è¿‡æ»¤
                return null;
            });
        }
        
        return builder.build();
    }
}
```

**é€‚ç”¨åœºæ™¯**:
- âœ… éœ€è¦æ›´å…¨é¢æ£€ç´¢ç»“æœçš„åœºæ™¯
- âœ… éœ€è¦åŠ¨æ€è°ƒæ•´æ£€ç´¢å‚æ•°çš„åœºæ™¯
- âœ… éœ€è¦åŸºäºç”¨æˆ·/æŸ¥è¯¢åŠ¨æ€è¿‡æ»¤çš„åœºæ™¯

**åŠ¨æ€é…ç½®ç¤ºä¾‹**:

**1. åŠ¨æ€æœ€å¤§ç»“æœæ•°**
```java
// æ ¹æ®æŸ¥è¯¢å¤æ‚åº¦è°ƒæ•´
.dynamicMaxResults(query -> {
    if (query.text().length() > 100) {
        return 15;  // å¤æ‚æŸ¥è¯¢è¿”å›æ›´å¤šç»“æœ
    }
    return 10;  // ç®€å•æŸ¥è¯¢è¿”å›æ ‡å‡†æ•°é‡
})
```

**2. åŠ¨æ€æœ€å°åˆ†æ•°**
```java
// æ ¹æ®æŸ¥è¯¢ç±»å‹è°ƒæ•´é˜ˆå€¼
.dynamicMinScore(query -> {
    // æŸäº›æŸ¥è¯¢å¯ä»¥é™ä½é˜ˆå€¼
    return 0.5;
})
```

**3. åŠ¨æ€è¿‡æ»¤å™¨**
```java
// æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤
.dynamicFilter(query -> {
    String userId = query.metadata()
        .invocationParameters()
        .get("userId");
    
    // åªè¿”å›ç”¨æˆ·æœ‰æƒè®¿é—®çš„æ–‡æ¡£
    return metadataKey("userId").isEqualTo(userId);
})
```

---

### 4. ContentRetrieverFactoryï¼ˆå·¥å‚ç±»ï¼‰

```java
@Component
@RequiredArgsConstructor
public class ContentRetrieverFactory {
    private final List<ContentRetrieverStrategy> retrieverStrategies;
    
    // è·å–æŒ‡å®šç±»å‹çš„æ£€ç´¢å™¨
    public Optional<ContentRetrieverStrategy> getStrategy(ContentRetrieverType type);
    
    // è·å–é»˜è®¤æ£€ç´¢å™¨ï¼ˆåµŒå…¥å¼å­˜å‚¨ï¼‰
    public ContentRetrieverStrategy getDefaultStrategy();
    
    // è·å–åµŒå…¥å¼å­˜å‚¨æ£€ç´¢å™¨
    public ContentRetrieverStrategy getEmbeddingStoreStrategy();
    
    // è·å–ç½‘ç»œæœç´¢æ£€ç´¢å™¨ï¼ˆå¯èƒ½ä¸å¯ç”¨ï¼‰
    public Optional<ContentRetrieverStrategy> getWebSearchStrategy();
    
    // åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ£€ç´¢å™¨
    public Map<ContentRetrieverType, String> listAvailableRetrievers();
}
```

---

## åœ¨ RAG æµç¨‹ä¸­çš„ä½ç½®

```
ç”¨æˆ·æŸ¥è¯¢
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ QueryTransformerï¼ˆæŸ¥è¯¢è½¬æ¢ï¼‰â”‚
â”‚  ä¼˜åŒ–æŸ¥è¯¢è¡¨è¾¾                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ ContentRetrieverï¼ˆå†…å®¹æ£€ç´¢ï¼‰â­â”‚
â”‚  ä»æ•°æ®æºæ£€ç´¢ç›¸å…³å†…å®¹              â”‚
â”‚  - EmbeddingStoreæ£€ç´¢            â”‚
â”‚  - å‘é‡ç›¸ä¼¼åº¦è®¡ç®—                 â”‚
â”‚  - è¿‡æ»¤å’Œæ’åº                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ ContentAggregatorï¼ˆå†…å®¹èšåˆï¼‰â”‚
â”‚  èšåˆå¤šä¸ªæ£€ç´¢ç»“æœ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£ ContentInjectorï¼ˆå†…å®¹æ³¨å…¥ï¼‰  â”‚
â”‚  å°†å†…å®¹æ³¨å…¥åˆ°ç”¨æˆ·æ¶ˆæ¯              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
å¢å¼ºåçš„ Prompt â†’ LLM â†’ å›ç­”
```

---

## é…ç½®è¯´æ˜

### application.properties

```properties
# RAG æ£€ç´¢å¢å¼ºå™¨é…ç½®
# é»˜è®¤å¢å¼ºå™¨ - æœ€å¤§æ£€ç´¢ç»“æœæ•°
rag.retrieval.max-results=5
# é»˜è®¤å¢å¼ºå™¨ - æœ€å°ç›¸å…³æ€§åˆ†æ•° (0.0-1.0)
rag.retrieval.min-score=0.6

# é«˜çº§å¢å¼ºå™¨ - æœ€å¤§æ£€ç´¢ç»“æœæ•°
rag.retrieval.advanced.max-results=10
# é«˜çº§å¢å¼ºå™¨ - æœ€å°ç›¸å…³æ€§åˆ†æ•°
rag.retrieval.advanced.min-score=0.5

# RAG å†…å®¹æ£€ç´¢å™¨é…ç½®
# æ˜¯å¦å¯ç”¨åŠ¨æ€é…ç½®ï¼ˆåŠ¨æ€æœ€å¤§ç»“æœæ•°ã€æœ€å°åˆ†æ•°ã€è¿‡æ»¤å™¨ï¼‰
rag.retrieval.dynamic.enabled=false
```

### å‚æ•°è¯´æ˜

| å‚æ•° | å«ä¹‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|--------|------|
| **rag.retrieval.max-results** | æœ€å¤§æ£€ç´¢ç»“æœæ•° | 5 | æ ‡å‡†æ£€ç´¢è¿”å›çš„æ–‡æ¡£æ•° |
| **rag.retrieval.min-score** | æœ€å°ç›¸å…³æ€§åˆ†æ•° | 0.6 | ä½äºæ­¤åˆ†æ•°çš„æ–‡æ¡£ä¼šè¢«è¿‡æ»¤ |
| **rag.retrieval.advanced.max-results** | é«˜çº§æ£€ç´¢æœ€å¤§ç»“æœæ•° | 10 | æ›´å…¨é¢çš„æ£€ç´¢ |
| **rag.retrieval.advanced.min-score** | é«˜çº§æ£€ç´¢æœ€å°åˆ†æ•° | 0.5 | æ›´å®½æ¾çš„é˜ˆå€¼ |
| **rag.retrieval.dynamic.enabled** | å¯ç”¨åŠ¨æ€é…ç½® | false | æ”¯æŒåŠ¨æ€è°ƒæ•´å‚æ•° |

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºæœ¬ä½¿ç”¨

```java
@Autowired
private ContentRetrieverFactory contentRetrieverFactory;

// è·å–é»˜è®¤æ£€ç´¢å™¨
ContentRetrieverStrategy strategy = contentRetrieverFactory.getDefaultStrategy();
ContentRetriever retriever = strategy.getRetriever();

// åˆ›å»º AI æœåŠ¡
RetrievalAugmentor augmentor = DefaultRetrievalAugmentor.builder()
        .contentRetriever(retriever)
        .build();

Assistant assistant = AiServices.builder(Assistant.class)
        .chatLanguageModel(chatModel)
        .retrievalAugmentor(augmentor)
        .build();

// ä½¿ç”¨
String answer = assistant.chat("Spring Bootå¦‚ä½•é…ç½®æ•°æ®æºï¼Ÿ");
```

### ç¤ºä¾‹2: ä½¿ç”¨åŠ¨æ€è¿‡æ»¤å™¨

**åœºæ™¯**: å¤šç§Ÿæˆ·åº”ç”¨ï¼Œæ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ–‡æ¡£

**é…ç½®**:
```properties
rag.retrieval.dynamic.enabled=true
```

**å®ç°**:
```java
// å®šä¹‰ Assistant æ¥å£
interface Assistant {
    String chat(@UserMessage String message, 
                InvocationParameters parameters);
}

// ä½¿ç”¨æ—¶ä¼ é€’ç”¨æˆ·ID
InvocationParameters params = InvocationParameters.from(
    Map.of("userId", "user123")
);

String answer = assistant.chat("æˆ‘çš„æ–‡æ¡£æœ‰å“ªäº›ï¼Ÿ", params);

// ContentRetriever ä¼šè‡ªåŠ¨åº”ç”¨è¿‡æ»¤å™¨
// åªæ£€ç´¢ userId = "user123" çš„æ–‡æ¡£
```

### ç¤ºä¾‹3: åŠ¨æ€è°ƒæ•´ç»“æœæ•°

```java
// åœ¨ AdvancedEmbeddingStoreRetrieverStrategy ä¸­é…ç½®
.dynamicMaxResults(query -> {
    // ç®€å•æŸ¥è¯¢ï¼š5ä¸ªç»“æœ
    if (query.text().length() < 50) {
        return 5;
    }
    // ä¸­ç­‰æŸ¥è¯¢ï¼š10ä¸ªç»“æœ
    else if (query.text().length() < 100) {
        return 10;
    }
    // å¤æ‚æŸ¥è¯¢ï¼š15ä¸ªç»“æœ
    else {
        return 15;
    }
})
```

---

## æ‰©å±•ï¼šå…¶ä»–ç±»å‹çš„æ£€ç´¢å™¨

### WebSearchContentRetrieverï¼ˆç½‘ç»œæœç´¢ï¼‰

**ç”¨é€”**: ä»äº’è”ç½‘æœç´¢ç›¸å…³å†…å®¹

**ç¤ºä¾‹å®ç°**:
```java
@Component
@ConditionalOnBean(WebSearchEngine.class)
public class WebSearchContentRetrieverStrategy implements ContentRetrieverStrategy {
    
    private final WebSearchEngine webSearchEngine;
    
    @Override
    public ContentRetriever getRetriever() {
        return WebSearchContentRetriever.builder()
                .webSearchEngine(webSearchEngine)
                .maxResults(3)
                .build();
    }
}
```

**ä½¿ç”¨åœºæ™¯**:
- éœ€è¦æœ€æ–°ä¿¡æ¯çš„æŸ¥è¯¢
- ç§æœ‰çŸ¥è¯†åº“æ²¡æœ‰çš„å†…å®¹
- å®æ—¶æ–°é—»å’ŒåŠ¨æ€

---

### SqlDatabaseContentRetrieverï¼ˆSQLæ•°æ®åº“ï¼‰

**ç”¨é€”**: ä½¿ç”¨è‡ªç„¶è¯­è¨€æŸ¥è¯¢SQLæ•°æ®åº“

**ç¤ºä¾‹å®ç°**:
```java
@Component
@ConditionalOnBean(DataSource.class)
public class SqlDatabaseContentRetrieverStrategy implements ContentRetrieverStrategy {
    
    private final DataSource dataSource;
    private final ChatModel chatModel;
    
    @Override
    public ContentRetriever getRetriever() {
        return SqlDatabaseContentRetriever.builder()
                .dataSource(dataSource)
                .chatModel(chatModel)
                .build();
    }
}
```

**å·¥ä½œåŸç†**:
```
è‡ªç„¶è¯­è¨€æŸ¥è¯¢: "2023å¹´é”€å”®é¢æœ€é«˜çš„äº§å“"
    â†“
LLM ç”Ÿæˆ SQL:
SELECT product_name, SUM(sales) as total
FROM orders
WHERE year = 2023
GROUP BY product_name
ORDER BY total DESC
LIMIT 1
    â†“
æ‰§è¡Œ SQL å¹¶è¿”å›ç»“æœ
```

---

### AzureAiSearchContentRetrieverï¼ˆAzure AI Searchï¼‰

**ç”¨é€”**: ä½¿ç”¨Azure AI Searchè¿›è¡Œæ··åˆæœç´¢ï¼ˆå‘é‡ + å…¨æ–‡ï¼‰

**ç‰¹ç‚¹**:
- æ”¯æŒå…¨æ–‡æœç´¢
- æ”¯æŒå‘é‡æœç´¢
- æ”¯æŒæ··åˆæœç´¢
- æ”¯æŒç»“æœé‡æ’åº

---

## å®Œæ•´çš„ RAG ç³»ç»Ÿæ¶æ„

### é¡¹ç›®ç»“æ„

```
src/main/java/org/example/ragtest/
â””â”€â”€ retrieval/                       # æ£€ç´¢åŒ…
    â”œâ”€â”€ retriever/                   # å†…å®¹æ£€ç´¢å™¨åŒ…ï¼ˆæ–°å¢ï¼‰â­
    â”‚   â”œâ”€â”€ ContentRetrieverStrategy.java    # æ£€ç´¢å™¨ç­–ç•¥æ¥å£
    â”‚   â”œâ”€â”€ ContentRetrieverType.java        # æ£€ç´¢å™¨ç±»å‹æšä¸¾
    â”‚   â”œâ”€â”€ ContentRetrieverFactory.java     # æ£€ç´¢å™¨å·¥å‚
    â”‚   â””â”€â”€ impl/                            # æ£€ç´¢å™¨ç­–ç•¥å®ç°
    â”‚       â”œâ”€â”€ EmbeddingStoreContentRetrieverStrategy.java
    â”‚       â””â”€â”€ AdvancedEmbeddingStoreRetrieverStrategy.java
    â”œâ”€â”€ query/                       # æŸ¥è¯¢è½¬æ¢å™¨
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ impl/                        # æ£€ç´¢å¢å¼ºå™¨å®ç°
    â”‚   â””â”€â”€ ...
    â””â”€â”€ ...
```

### å®Œæ•´çš„ç»„ä»¶çŸ©é˜µ

| é˜¶æ®µ | å±‚çº§ | åŠŸèƒ½æ¨¡å— | ç­–ç•¥æ•°é‡ | å·¥å‚ç±» | æ ¸å¿ƒä»·å€¼ | çŠ¶æ€ |
|-----|-----|---------|---------|-------|---------|------|
| **ç¦»çº¿** | 1ï¸âƒ£ åŠ è½½å±‚ | DocumentLoader | 3ç§ | DocumentLoaderFactory | å¤šæºåŠ è½½ | âœ… |
| **ç¦»çº¿** | 2ï¸âƒ£ è§£æå±‚ | DocumentParser | 3ç§ | DocumentParserFactory | æ™ºèƒ½è§£æ | âœ… |
| **ç¦»çº¿** | 3ï¸âƒ£ è½¬æ¢å±‚ | DocumentTransformer | 4ç§ | DocumentTransformerFactory | æ–‡æ¡£é¢„å¤„ç† | âœ… |
| **ç¦»çº¿** | 4ï¸âƒ£ åˆ†å‰²å±‚ | DocumentSplitter | 4ç§ | DocumentSplitterFactory | çµæ´»åˆ†å‰² | âœ… |
| **ç¦»çº¿** | 5ï¸âƒ£ å¢å¼ºå±‚ | TextSegmentTransformer | 3ç§ | TextSegmentTransformerFactory | æå‡æ£€ç´¢ | âœ… |
| **åœ¨çº¿** | 6ï¸âƒ£ æŸ¥è¯¢å±‚ | QueryTransformer | 3ç§ | QueryTransformerFactory | æŸ¥è¯¢ä¼˜åŒ– | âœ… |
| **åœ¨çº¿** | 7ï¸âƒ£ æ£€ç´¢å±‚ | ContentRetriever | 2ç§+ | ContentRetrieverFactory | å†…å®¹æ£€ç´¢ â­ | âœ… |
| **åœ¨çº¿** | 8ï¸âƒ£ å¢å¼ºå±‚ | RetrievalAugmentor | 3ç§ | RetrievalAugmentorFactory | RAGå…¥å£ | âœ… |

**æ€»è®¡**: 25+ç§ç­–ç•¥ + 8ä¸ªå·¥å‚ = **å®Œæ•´çš„ä¼ä¸šçº§RAGç³»ç»Ÿ**

---

## ä¼˜åŠ¿æ€»ç»“

### 1. **çµæ´»çš„æ•°æ®æºæ”¯æŒ**
- âœ… åµŒå…¥å¼å­˜å‚¨ï¼ˆå‘é‡æ£€ç´¢ï¼‰
- âœ… å¯æ‰©å±•åˆ°ç½‘ç»œæœç´¢ã€SQLã€å›¾æ•°æ®åº“ç­‰
- âœ… æ”¯æŒæ··åˆæ£€ç´¢ç­–ç•¥

### 2. **åŠ¨æ€é…ç½®èƒ½åŠ›** â­
- âœ… åŠ¨æ€è°ƒæ•´æœ€å¤§ç»“æœæ•°
- âœ… åŠ¨æ€è°ƒæ•´ç›¸å…³æ€§é˜ˆå€¼
- âœ… åŠ¨æ€åº”ç”¨è¿‡æ»¤å™¨ï¼ˆå¤šç§Ÿæˆ·ã€æƒé™ç­‰ï¼‰

### 3. **é«˜æ€§èƒ½æ£€ç´¢**
- âœ… åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰æ£€ç´¢
- âœ… å¯é…ç½®çš„ç›¸å…³æ€§é˜ˆå€¼
- âœ… æŒ‰ç›¸å…³æ€§æ’åºçš„ç»“æœ

### 4. **æ˜“äºæ‰©å±•**
- âœ… ç­–ç•¥æ¨¡å¼ä½¿æ·»åŠ æ–°æ£€ç´¢å™¨ç®€å•
- âœ… å·¥å‚æ¨¡å¼ç»Ÿä¸€ç®¡ç†
- âœ… æ¡ä»¶åŒ–Beanæ³¨å†Œ

---

## æœ€ä½³å®è·µå»ºè®®

### 1. é€‰æ‹©åˆé€‚çš„æ£€ç´¢å™¨

| åœºæ™¯ | æ¨èæ£€ç´¢å™¨ | åŸå›  |
|-----|----------|------|
| ç§æœ‰çŸ¥è¯†åº“ | EmbeddingStore | è¯­ä¹‰æ£€ç´¢æœ€å‡†ç¡® |
| å®æ—¶ä¿¡æ¯ | WebSearch | è·å–æœ€æ–°å†…å®¹ |
| ç»“æ„åŒ–æ•°æ® | SqlDatabase | SQLæŸ¥è¯¢æ•ˆç‡é«˜ |
| æ··åˆéœ€æ±‚ | Hybrid | ç»“åˆå¤šç§ä¼˜åŠ¿ |

### 2. å‚æ•°è°ƒä¼˜

**maxResultsï¼ˆæœ€å¤§ç»“æœæ•°ï¼‰**:
- å°‘é‡ï¼ˆ3-5ï¼‰: å¿«é€Ÿå“åº”ï¼Œtokenæ¶ˆè€—ä½
- ä¸­é‡ï¼ˆ5-10ï¼‰: å¹³è¡¡è´¨é‡å’Œæ€§èƒ½
- å¤§é‡ï¼ˆ10-15ï¼‰: å…¨é¢è¦†ç›–ï¼Œtokenæ¶ˆè€—é«˜

**minScoreï¼ˆæœ€å°åˆ†æ•°ï¼‰**:
- é«˜ï¼ˆ0.7-0.9ï¼‰: ç²¾å‡†ä½†å¯èƒ½é—æ¼
- ä¸­ï¼ˆ0.5-0.7ï¼‰: å¹³è¡¡ â­ æ¨è
- ä½ï¼ˆ0.3-0.5ï¼‰: å¬å›ç‡é«˜ä½†å™ªéŸ³å¤š

### 3. åŠ¨æ€é…ç½®çš„åº”ç”¨

å¯ç”¨åŠ¨æ€é…ç½®é€‚ç”¨äºï¼š
- å¤šç§Ÿæˆ·åº”ç”¨ï¼ˆæƒé™è¿‡æ»¤ï¼‰
- ä¸åŒç±»å‹æŸ¥è¯¢éœ€è¦ä¸åŒå‚æ•°
- éœ€è¦æ ¹æ®ç”¨æˆ·è¡Œä¸ºè°ƒæ•´

---

## æ€»ç»“

é€šè¿‡å®ç°å†…å®¹æ£€ç´¢å™¨ï¼ˆContentRetrieverï¼‰ï¼Œæˆ‘ä»¬ä¸ºRAGç³»ç»Ÿå»ºç«‹äº†çµæ´»çš„å†…å®¹æ£€ç´¢å±‚ï¼š

### æ ¸å¿ƒä»·å€¼

1. **çµæ´»çš„æ•°æ®æº**: æ”¯æŒå¤šç§æ•°æ®æºç±»å‹
2. **åŠ¨æ€é…ç½®**: æ ¹æ®æŸ¥è¯¢åŠ¨æ€è°ƒæ•´æ£€ç´¢ç­–ç•¥
3. **é«˜è´¨é‡æ£€ç´¢**: åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰æ£€ç´¢
4. **æ˜“äºæ‰©å±•**: å¯æ·»åŠ æ–°çš„æ£€ç´¢å™¨ç±»å‹

### RAGç³»ç»Ÿå®Œæ•´åº¦

```
æ–‡æ¡£å‡†å¤‡é˜¶æ®µï¼ˆç¦»çº¿ï¼‰:
åŠ è½½ â†’ è§£æ â†’ æ–‡æ¡£è½¬æ¢ â†’ åˆ†å‰² â†’ æ–‡æœ¬æ®µå¢å¼º â†’ å‘é‡å­˜å‚¨

æŸ¥è¯¢å¤„ç†é˜¶æ®µï¼ˆåœ¨çº¿ï¼‰:
ç”¨æˆ·æŸ¥è¯¢ â†’ æŸ¥è¯¢è½¬æ¢ â†’ å†…å®¹æ£€ç´¢ â­ â†’ æ£€ç´¢å¢å¼º â†’ LLM â†’ å›ç­”
```

**ContentRetrieveræ˜¯RAGç³»ç»Ÿçš„æ ¸å¿ƒæ£€ç´¢å¼•æ“ï¼** ğŸ‰
