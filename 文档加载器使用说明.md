# 文档加载器使用说明

本项目已实现动态选择文档加载器功能，支持三种不同的加载方式。

> **🎯 重构说明**: 本项目使用了**策略模式**和**工厂模式**重构文档加载功能，详细的设计模式说明请查看 `设计模式重构说明.md`

## 架构亮点

- ✅ 使用**策略模式**封装不同的加载策略
- ✅ 使用**工厂模式**管理加载器实例
- ✅ 遵循 **SOLID 原则**，代码更易维护和扩展
- ✅ 支持动态添加新的加载器类型

## 支持的文档加载器

### 1. FileSystemDocumentLoader (文件系统加载器)
- **用途**: 从本地文件系统加载文档
- **支持格式**: 
  - 文本文件 (.txt, .md 等)
  - PDF 文件 (.pdf) - 自动使用 Apache PDFBox 解析器
- **特性**: 可以加载单个文件或整个目录

### 2. UrlDocumentLoader (URL加载器)
- **用途**: 从互联网URL加载文档
- **支持格式**: 任何可通过HTTP/HTTPS访问的文本内容
- **特性**: 自动处理网络请求

### 3. ClassPathDocumentLoader (类路径加载器)
- **用途**: 从项目资源目录(resources)加载文档
- **支持格式**: 项目内嵌的资源文件
- **特性**: 适合加载预打包的文档

## API 端点说明

### 1. 从文件系统加载单个文档
**端点**: `POST /api/rag/ingest-from-file`

**请求示例**:
```json
{
  "filePath": "C:/documents/example.txt"
}
```

**支持PDF**:
```json
{
  "filePath": "C:/documents/example.pdf"
}
```

---

### 2. 从文件系统批量加载（目录）
**端点**: `POST /api/rag/ingest-from-directory`

**请求示例**:
```json
{
  "directoryPath": "C:/documents/"
}
```

---

### 3. 从URL加载文档
**端点**: `POST /api/rag/ingest-from-url`

**请求示例**:
```json
{
  "url": "https://example.com/document.txt"
}
```

---

### 4. 从类路径加载文档
**端点**: `POST /api/rag/ingest-from-classpath`

**请求示例**:
```json
{
  "resourcePath": "docs/javadoc.md"
}
```

**注意**: 路径相对于 `src/main/resources` 目录

---

### 5. 动态选择加载器 (推荐)
**端点**: `POST /api/rag/ingest-dynamic`

这是统一的动态加载接口，可以通过指定加载器类型来选择不同的加载方式。

**请求示例**:

#### 使用文件系统加载器
```json
{
  "loaderType": "FILE_SYSTEM",
  "sourcePath": "C:/documents/example.txt"
}
```

#### 使用URL加载器
```json
{
  "loaderType": "URL",
  "sourcePath": "https://example.com/document.txt"
}
```

#### 使用类路径加载器
```json
{
  "loaderType": "CLASSPATH",
  "sourcePath": "docs/javadoc.md"
}
```

**加载器类型枚举**:
- `FILE_SYSTEM` - 文件系统加载器
- `URL` - URL加载器
- `CLASSPATH` - 类路径加载器

---

## 代码示例

### 在 Java 代码中直接调用

```java
@Autowired
private DocumentService documentService;

// 1. 从文件系统加载
documentService.ingestDocumentFromFile("C:/documents/example.txt");

// 2. 批量加载目录
documentService.ingestDocumentsFromDirectory("C:/documents/");

// 3. 从URL加载
documentService.ingestDocumentFromUrl("https://example.com/doc.txt");

// 4. 从类路径加载
documentService.ingestDocumentFromClasspath("docs/javadoc.md");

// 5. 动态选择加载器
documentService.ingestDocumentByLoaderType(
    DocumentLoaderType.FILE_SYSTEM, 
    "C:/documents/example.txt"
);
```

---

## 文档处理流程

所有加载器加载的文档都会经过以下处理流程：

1. **文档加载**: 使用指定的加载器读取文档内容
2. **文档解析**: 
   - PDF文件使用 `ApachePdfBoxDocumentParser`
   - 其他文件使用 `TextDocumentParser`
3. **文档分割**: 使用递归分割器，配置如下：
   - 每个块最大字符数: 300
   - 块之间重叠字符数: 50
4. **向量化**: 使用 all-MiniLM-L6-v2 模型生成向量
5. **存储**: 存储到内存向量数据库

---

## 支持的文件格式

项目支持以下文件格式的自动解析：

| 格式类型 | 文件扩展名 | 解析器 | 
|---------|-----------|-------|
| **文本** | txt, html, htm, md, log, csv, json, xml | TextDocumentParser |
| **PDF** | pdf | ApachePdfBoxDocumentParser |
| **MS Office** | doc, docx, ppt, pptx, xls, xlsx | ApachePoiDocumentParser |

**特性**:
- ✅ 根据文件扩展名自动选择合适的解析器
- ✅ 无需手动指定解析器类型
- ✅ 支持混合格式文件处理

---

## 配置说明

### 文档分割器配置

在 `DocumentService` 中可以调整分割参数：

```java
DocumentSplitter splitter = DocumentSplitters.recursive(
    300,  // maxSegmentSizeInChars - 每个块的最大字符数
    50    // maxOverlapSizeInChars - 块之间的重叠字符数
);
```

### Embedding 模型

项目使用本地 Embedding 模型，无需 GPU：
- 模型: all-MiniLM-L6-v2 (量化版本)
- 配置位置: `RagConfig.java`

---

## 测试建议

1. **测试文本文件**: 使用简单的 .txt 文件测试基本功能
2. **测试PDF文件**: 验证PDF解析是否正常工作
3. **测试URL加载**: 使用公开的文本URL测试
4. **测试类路径**: 在 resources 目录下放置测试文件

---

## 常见问题

### Q: 支持哪些文件格式？
A: 目前支持文本文件和PDF文件。PDF使用Apache PDFBox解析，其他文件作为文本处理。

### Q: 可以加载多大的文件？
A: 理论上没有大小限制，但建议大文件使用目录批量加载或分批处理。

### Q: URL加载失败怎么办？
A: 确保URL可访问，网络连接正常，且目标内容是文本格式。

### Q: 类路径资源找不到？
A: 确保文件位于 `src/main/resources` 目录下，路径相对于该目录。

### Q: 如何扩展支持更多文件格式？
A: 在 `ingestDocumentFromFile` 方法中添加新的解析器判断逻辑，并在 pom.xml 中添加相应的解析器依赖。

---

## 依赖说明

项目已包含所有必要的依赖：

```xml
<!-- 文档解析器 -->
<!-- PDF解析器 -->
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-document-parser-apache-pdfbox</artifactId>
    <version>${langchain4j.version}</version>
</dependency>

<!-- MS Office 解析器 (DOC, DOCX, PPT, PPTX, XLS, XLSX) -->
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-document-parser-apache-poi</artifactId>
    <version>${langchain4j.version}</version>
</dependency>

<!-- 本地Embedding模型 -->
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-embeddings-all-minilm-l6-v2-q</artifactId>
    <version>${langchain4j.version}</version>
</dependency>

<!-- LangChain4j核心库（包含DocumentLoader） -->
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j</artifactId>
    <version>1.7.1</version>
</dependency>
```
