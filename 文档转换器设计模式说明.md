# æ–‡æ¡£è½¬æ¢å™¨è®¾è®¡æ¨¡å¼è¯´æ˜

## é‡æ„æ¦‚è¿°

ä½¿ç”¨**ç­–ç•¥æ¨¡å¼**å’Œ**å·¥å‚æ¨¡å¼**å®ç°æ–‡æ¡£è½¬æ¢å™¨ï¼ˆDocumentTransformerï¼‰åŠŸèƒ½ï¼Œæä¾›æ–‡æ¡£é¢„å¤„ç†èƒ½åŠ›ï¼ŒåŒ…æ‹¬æ¸…ç†ã€ç­›é€‰ã€å…ƒæ•°æ®å¢å¼ºç­‰æ“ä½œã€‚

---

## è®¾è®¡æ¨¡å¼åº”ç”¨

### ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**ç›®çš„**: å®šä¹‰ä¸€ç³»åˆ—æ–‡æ¡£è½¬æ¢ç®—æ³•ï¼Œå°è£…æ¯ä¸€ä¸ªç®—æ³•ï¼Œå¹¶ä½¿å®ƒä»¬å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚

**å®ç°**:
- **ç­–ç•¥æ¥å£**: `DocumentTransformerStrategy`
- **å…·ä½“ç­–ç•¥**:
  - `CleaningDocumentTransformer` - æ¸…ç†æ–‡æ¡£å™ªéŸ³
  - `FilteringDocumentTransformer` - ç­›é€‰æ–‡æ¡£
  - `MetadataEnhancerTransformer` - å¢å¼ºå…ƒæ•°æ®
  - `CompositeDocumentTransformer` - ç»„åˆå¤šä¸ªè½¬æ¢å™¨

### å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

**å®ç°**:
- **å·¥å‚ç±»**: `DocumentTransformerFactory`
- **åŠŸèƒ½**: 
  - æ ¹æ®ç±»å‹åˆ›å»ºè½¬æ¢å™¨
  - åˆ›å»ºç»„åˆè½¬æ¢å™¨é“¾
  - æä¾›é»˜è®¤å¤„ç†æµç¨‹

---

## æ¶æ„è®¾è®¡

```
æ–‡æ¡£å¤„ç†æµç¨‹ï¼ˆå››å±‚ç­–ç•¥æ¨¡å¼ï¼‰:

1. åŠ è½½æ–‡æ¡£
   DocumentLoaderFactory â†’ DocumentLoader
   â†“
2. è§£ææ–‡æ¡£
   DocumentParserFactory â†’ DocumentParser
   â†“
3. è½¬æ¢æ–‡æ¡£ â­ (æ–°å¢)
   DocumentTransformerFactory â†’ DocumentTransformer
   â”œâ†’ CleaningTransformer (æ¸…ç†)
   â”œâ†’ MetadataEnhancer (å¢å¼ºå…ƒæ•°æ®)
   â””â†’ FilteringTransformer (ç­›é€‰)
   â†“
4. åˆ†å‰²æ–‡æ¡£
   DocumentSplitterFactory â†’ DocumentSplitter
   â†“
5. å‘é‡åŒ–å­˜å‚¨
   EmbeddingModel + EmbeddingStore
```

---

## æ ¸å¿ƒç±»è¯´æ˜

### 1. DocumentTransformerTypeï¼ˆæšä¸¾ï¼‰

```java
public enum DocumentTransformerType {
    CLEANING,           // æ¸…ç†è½¬æ¢å™¨
    FILTERING,          // ç­›é€‰è½¬æ¢å™¨
    METADATA_ENHANCER,  // å…ƒæ•°æ®å¢å¼ºè½¬æ¢å™¨
    HTML_TO_TEXT,       // HTMLè½¬æ–‡æœ¬
    SUMMARIZER,         // æ‘˜è¦è½¬æ¢å™¨
    COMPOSITE           // ç»„åˆè½¬æ¢å™¨
}
```

---

### 2. DocumentTransformerStrategyï¼ˆç­–ç•¥æ¥å£ï¼‰

```java
public interface DocumentTransformerStrategy {
    // è½¬æ¢å•ä¸ªæ–‡æ¡£
    Document transform(Document document);
    
    // æ‰¹é‡è½¬æ¢
    List<Document> transformAll(List<Document> documents);
    
    // è·å–è½¬æ¢å™¨ç±»å‹
    DocumentTransformerType getTransformerType();
    
    // è·å–æè¿°
    String getDescription();
    
    // æ˜¯å¦å¯ç”¨
    default boolean isEnabled() { return true; }
}
```

---

### 3. å…·ä½“è½¬æ¢å™¨å®ç°

#### CleaningDocumentTransformerï¼ˆæ¸…ç†è½¬æ¢å™¨ï¼‰

**åŠŸèƒ½**:
- å»é™¤å¤šä½™ç©ºç™½è¡Œ
- å»é™¤è¡Œé¦–è¡Œå°¾ç©ºç™½
- å»é™¤ç‰¹æ®Šæ§åˆ¶å­—ç¬¦
- å»é™¤é›¶å®½å­—ç¬¦
- ç»Ÿä¸€å¤šä¸ªç©ºæ ¼ä¸ºå•ä¸ªç©ºæ ¼

**ä½¿ç”¨åœºæ™¯**:
- å¤„ç†ä»ç½‘é¡µã€PDFç­‰æå–çš„æ–‡æœ¬
- å»é™¤æ ¼å¼åŒ–å™ªéŸ³
- æé«˜æ–‡æœ¬è´¨é‡

**ç¤ºä¾‹**:
```java
@Component
public class CleaningDocumentTransformer implements DocumentTransformerStrategy {
    @Override
    public Document transform(Document document) {
        String cleanedText = cleanText(document.text());
        return Document.from(cleanedText, document.metadata());
    }
    
    private String cleanText(String text) {
        return text
            .replaceAll("\\n{3,}", "\n\n")     // å»é™¤å¤šä½™æ¢è¡Œ
            .replaceAll(" {2,}", " ")           // å¤šç©ºæ ¼â†’å•ç©ºæ ¼
            .trim();
    }
}
```

---

#### MetadataEnhancerTransformerï¼ˆå…ƒæ•°æ®å¢å¼ºè½¬æ¢å™¨ï¼‰

**åŠŸèƒ½**:
- ç»Ÿè®¡å­—æ•°ï¼ˆword_countï¼‰
- ç»Ÿè®¡å­—ç¬¦æ•°ï¼ˆchar_countï¼‰
- æ·»åŠ å¤„ç†æ—¶é—´ï¼ˆprocessed_atï¼‰
- æ–‡æ¡£é•¿åº¦åˆ†ç±»ï¼ˆlength_category: short/medium/long/very_longï¼‰
- è¯­è¨€æ£€æµ‹ï¼ˆlanguage: zh/enï¼‰

**ä½¿ç”¨åœºæ™¯**:
- ä¸ºæ–‡æ¡£æ·»åŠ é¢å¤–ä¿¡æ¯
- ä¾¿äºåç»­æ£€ç´¢å’Œç­›é€‰
- æä¾›æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯

**ç¤ºä¾‹**:
```java
@Component
public class MetadataEnhancerTransformer implements DocumentTransformerStrategy {
    @Override
    public Document transform(Document document) {
        Metadata metadata = document.metadata();
        
        // æ·»åŠ å„ç§å…ƒæ•°æ®
        metadata.put("word_count", countWords(document.text()));
        metadata.put("char_count", document.text().length());
        metadata.put("processed_at", LocalDateTime.now().format(FORMATTER));
        metadata.put("language", detectLanguage(document.text()));
        
        return Document.from(document.text(), metadata);
    }
}
```

---

#### FilteringDocumentTransformerï¼ˆç­›é€‰è½¬æ¢å™¨ï¼‰

**åŠŸèƒ½**:
- é•¿åº¦è¿‡æ»¤ï¼ˆmin-length, max-lengthï¼‰
- ç©ºç™½å†…å®¹è¿‡æ»¤
- å¯æ‰©å±•è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™

**é…ç½®**:
```properties
# æœ€å°æ–‡æ¡£é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰
document.transformer.filter.min-length=50
# æœ€å¤§æ–‡æ¡£é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰
document.transformer.filter.max-length=50000
```

**ä½¿ç”¨åœºæ™¯**:
- è¿‡æ»¤è¿‡çŸ­æˆ–è¿‡é•¿çš„æ–‡æ¡£
- æ’é™¤æ— æ•ˆå†…å®¹
- èŠ‚çœå­˜å‚¨å’Œè®¡ç®—èµ„æº

**ç‰¹ç‚¹**:
- è¿”å› `null` è¡¨ç¤ºæ–‡æ¡£è¢«è¿‡æ»¤
- å¯é…ç½®è¿‡æ»¤é˜ˆå€¼

---

#### CompositeDocumentTransformerï¼ˆç»„åˆè½¬æ¢å™¨ï¼‰

**åŠŸèƒ½**:
- æŒ‰é¡ºåºåº”ç”¨å¤šä¸ªè½¬æ¢å™¨
- æ”¯æŒè½¬æ¢å™¨é“¾å¼è°ƒç”¨
- å¦‚æœæŸä¸ªè½¬æ¢å™¨è¿”å›nullï¼Œç»ˆæ­¢å¤„ç†

**å…¸å‹æµç¨‹**:
```
æ¸…ç† â†’ å¢å¼ºå…ƒæ•°æ® â†’ ç­›é€‰
```

**ç¤ºä¾‹**:
```java
// åˆ›å»ºç»„åˆè½¬æ¢å™¨
CompositeDocumentTransformer composite = new CompositeDocumentTransformer(
    cleaningTransformer,
    metadataEnhancer,
    filteringTransformer
);

// åº”ç”¨è½¬æ¢
Document result = composite.transform(document);
```

---

### 4. DocumentTransformerFactoryï¼ˆå·¥å‚ç±»ï¼‰

```java
@Component
@RequiredArgsConstructor
public class DocumentTransformerFactory {
    private final List<DocumentTransformerStrategy> transformerStrategies;
    
    // æ ¹æ®ç±»å‹è·å–è½¬æ¢å™¨
    public DocumentTransformerStrategy getTransformer(DocumentTransformerType type);
    
    // åˆ›å»ºç»„åˆè½¬æ¢å™¨
    public DocumentTransformerStrategy createCompositeTransformer(
        List<DocumentTransformerType> types);
    
    // åˆ›å»ºé»˜è®¤å¤„ç†æµç¨‹ï¼ˆæ¨èï¼‰
    public DocumentTransformerStrategy createDefaultPipeline();
    
    // åˆ—å‡ºæ‰€æœ‰å¯ç”¨è½¬æ¢å™¨
    public Map<DocumentTransformerType, String> listAvailableTransformers();
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… Springè‡ªåŠ¨æ³¨å…¥æ‰€æœ‰è½¬æ¢å™¨
- âœ… æä¾›é»˜è®¤å¤„ç†æµç¨‹
- âœ… æ”¯æŒè‡ªå®šä¹‰è½¬æ¢å™¨é“¾

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. ä½¿ç”¨é»˜è®¤è½¬æ¢æµç¨‹

```java
// é»˜è®¤æµç¨‹: æ¸…ç† â†’ å¢å¼ºå…ƒæ•°æ® â†’ ç­›é€‰
DocumentTransformerStrategy transformer = transformerFactory.createDefaultPipeline();
List<Document> transformed = transformer.transformAll(documents);
```

### 2. è‡ªå®šä¹‰è½¬æ¢å™¨é“¾

```java
// è‡ªå®šä¹‰: åªæ¸…ç† + å¢å¼ºå…ƒæ•°æ®
DocumentTransformerStrategy transformer = transformerFactory.createCompositeTransformer(
    DocumentTransformerType.CLEANING,
    DocumentTransformerType.METADATA_ENHANCER
);
```

### 3. å•ç‹¬ä½¿ç”¨æŸä¸ªè½¬æ¢å™¨

```java
// åªä½¿ç”¨æ¸…ç†è½¬æ¢å™¨
DocumentTransformerStrategy cleaner = transformerFactory.getTransformer(
    DocumentTransformerType.CLEANING);
Document cleaned = cleaner.transform(document);
```

### 4. é€šè¿‡APIä½¿ç”¨

#### è·å–å¯ç”¨è½¬æ¢å™¨åˆ—è¡¨
```bash
GET /api/rag/transformers
```

**å“åº”**:
```json
{
  "CLEANING": "æ¸…ç†è½¬æ¢å™¨ (å»é™¤å¤šä½™ç©ºç™½ã€ç‰¹æ®Šå­—ç¬¦ç­‰å™ªéŸ³)",
  "METADATA_ENHANCER": "å…ƒæ•°æ®å¢å¼ºè½¬æ¢å™¨ (æ·»åŠ å­—æ•°ã€å­—ç¬¦æ•°ã€å¤„ç†æ—¶é—´ã€è¯­è¨€ç­‰ä¿¡æ¯)",
  "FILTERING": "ç­›é€‰è½¬æ¢å™¨ (æœ€å°é•¿åº¦: 50, æœ€å¤§é•¿åº¦: 50000)"
}
```

#### ä½¿ç”¨è½¬æ¢å™¨æ‘„å–æ–‡æ¡£
```bash
POST /api/rag/ingest-with-transformers
Content-Type: application/json

{
  "loaderType": "FILE_SYSTEM",
  "sourcePath": "C:/docs/example.pdf",
  "transformerTypes": ["CLEANING", "METADATA_ENHANCER", "FILTERING"],
  "splitterType": "RECURSIVE"
}
```

---

## é…ç½®è¯´æ˜

### application.properties

```properties
# æ–‡æ¡£è½¬æ¢å™¨é…ç½®
# ç­›é€‰å™¨ - æœ€å°æ–‡æ¡£é•¿åº¦
document.transformer.filter.min-length=50
# ç­›é€‰å™¨ - æœ€å¤§æ–‡æ¡£é•¿åº¦  
document.transformer.filter.max-length=50000
```

**å‚æ•°è¯´æ˜**:
- `min-length`: è¿‡æ»¤æ‰å°‘äºæ­¤å­—ç¬¦æ•°çš„æ–‡æ¡£
- `max-length`: è¿‡æ»¤æ‰è¶…è¿‡æ­¤å­—ç¬¦æ•°çš„æ–‡æ¡£

---

## è½¬æ¢å™¨å¯¹æ¯”

| è½¬æ¢å™¨ç±»å‹ | ä¸»è¦åŠŸèƒ½ | è¿”å›ç»“æœ | ä½¿ç”¨åœºæ™¯ |
|----------|---------|---------|---------|
| **CLEANING** | å»é™¤å™ªéŸ³ | ä¿®æ”¹åçš„æ–‡æ¡£ | æ–‡æœ¬è´¨é‡æå‡ |
| **METADATA_ENHANCER** | æ·»åŠ å…ƒæ•°æ® | ä¿®æ”¹åçš„æ–‡æ¡£ | ä¿¡æ¯å¢å¼º |
| **FILTERING** | è¿‡æ»¤æ–‡æ¡£ | æ–‡æ¡£æˆ–null | å†…å®¹ç­›é€‰ |
| **COMPOSITE** | ç»„åˆå¤šä¸ªè½¬æ¢å™¨ | æœ€ç»ˆå¤„ç†ç»“æœ | å®Œæ•´å¤„ç†æµç¨‹ |

---

## æ‰©å±•æ–°çš„è½¬æ¢å™¨

### ç¤ºä¾‹ï¼šæ·»åŠ æ‘˜è¦è½¬æ¢å™¨

#### æ­¥éª¤1: åˆ›å»ºç­–ç•¥å®ç°
```java
@Component
public class SummarizerDocumentTransformer implements DocumentTransformerStrategy {
    
    @Autowired
    private ChatLanguageModel chatModel;  // ä½¿ç”¨LLMç”Ÿæˆæ‘˜è¦
    
    @Override
    public Document transform(Document document) {
        String text = document.text();
        
        // ç”Ÿæˆæ‘˜è¦
        String summary = chatModel.generate(
            "è¯·ä¸ºä»¥ä¸‹æ–‡æœ¬ç”Ÿæˆç®€çŸ­æ‘˜è¦ï¼š\n" + text);
        
        // æ·»åŠ åˆ°å…ƒæ•°æ®
        Metadata metadata = document.metadata();
        metadata.put("summary", summary);
        
        return Document.from(text, metadata);
    }
    
    @Override
    public DocumentTransformerType getTransformerType() {
        return DocumentTransformerType.SUMMARIZER;
    }
}
```

#### æ­¥éª¤2: å®Œæˆï¼
- âœ… Spring è‡ªåŠ¨æ³¨å…¥
- âœ… å·¥å‚è‡ªåŠ¨è¯†åˆ«
- âœ… ç«‹å³å¯ç”¨

---

## å®Œæ•´æ–‡æ¡£å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŠ è½½æ–‡æ¡£      â”‚  DocumentLoaderFactory
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è§£ææ–‡æ¡£      â”‚  DocumentParserFactory
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è½¬æ¢æ–‡æ¡£ â­   â”‚  DocumentTransformerFactory
â”‚  â”œâ”€æ¸…ç†         â”‚  â€¢ å»é™¤å™ªéŸ³
â”‚  â”œâ”€å¢å¼ºå…ƒæ•°æ®   â”‚  â€¢ æ·»åŠ ä¿¡æ¯
â”‚  â””â”€ç­›é€‰         â”‚  â€¢ è¿‡æ»¤æ— æ•ˆå†…å®¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åˆ†å‰²æ–‡æ¡£      â”‚  DocumentSplitterFactory
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å‘é‡åŒ–å­˜å‚¨    â”‚  EmbeddingModel + Store
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¼˜åŠ¿æ€»ç»“

### 1. **æ•°æ®è´¨é‡æå‡**
- âœ… å»é™¤å™ªéŸ³ï¼Œæé«˜æ–‡æœ¬è´¨é‡
- âœ… è¿‡æ»¤æ— æ•ˆå†…å®¹ï¼ŒèŠ‚çœèµ„æº
- âœ… å¢å¼ºå…ƒæ•°æ®ï¼Œä¾¿äºæ£€ç´¢

### 2. **çµæ´»æ€§**
- âœ… æ”¯æŒå¤šç§è½¬æ¢ç­–ç•¥
- âœ… å¯è‡ªç”±ç»„åˆè½¬æ¢å™¨
- âœ… æ˜“äºæ‰©å±•æ–°è½¬æ¢å™¨

### 3. **å¯ç»´æŠ¤æ€§**
- âœ… æ¯ä¸ªè½¬æ¢å™¨ç‹¬ç«‹å®ç°
- âœ… èŒè´£å•ä¸€ï¼Œæ˜“äºç†è§£
- âœ… ä¾¿äºå•å…ƒæµ‹è¯•

### 4. **å®Œæ•´æ€§**
- âœ… å½¢æˆå®Œæ•´çš„é¢„å¤„ç†æµç¨‹
- âœ… ä¸åŠ è½½ã€è§£æã€åˆ†å‰²æ— ç¼é›†æˆ
- âœ… æä¾›ç«¯åˆ°ç«¯çš„æ–‡æ¡£å¤„ç†èƒ½åŠ›

---

## é¡¹ç›®ç»“æ„

```
src/main/java/org/example/ragtest/
â”œâ”€â”€ transformer/                     # æ–‡æ¡£è½¬æ¢å™¨åŒ…ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ DocumentTransformerStrategy.java   # è½¬æ¢å™¨ç­–ç•¥æ¥å£
â”‚   â”œâ”€â”€ DocumentTransformerType.java       # è½¬æ¢å™¨ç±»å‹æšä¸¾
â”‚   â”œâ”€â”€ DocumentTransformerFactory.java    # è½¬æ¢å™¨å·¥å‚
â”‚   â””â”€â”€ impl/                              # è½¬æ¢å™¨ç­–ç•¥å®ç°
â”‚       â”œâ”€â”€ CleaningDocumentTransformer.java
â”‚       â”œâ”€â”€ MetadataEnhancerTransformer.java
â”‚       â”œâ”€â”€ FilteringDocumentTransformer.java
â”‚       â””â”€â”€ CompositeDocumentTransformer.java
â”œâ”€â”€ loader/                          # æ–‡æ¡£åŠ è½½å™¨åŒ…
â”œâ”€â”€ parser/                          # æ–‡æ¡£è§£æå™¨åŒ…
â”œâ”€â”€ splitter/                        # æ–‡æ¡£åˆ†å‰²å™¨åŒ…
â””â”€â”€ service/
    â””â”€â”€ DocumentService.java         # ä½¿ç”¨æ‰€æœ‰å·¥å‚
```

---

## æ€»ç»“

é€šè¿‡å¼•å…¥æ–‡æ¡£è½¬æ¢å™¨çš„ç­–ç•¥æ¨¡å¼å’Œå·¥å‚æ¨¡å¼ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **é¢„å¤„ç†èƒ½åŠ›**: æ¸…ç†ã€ç­›é€‰ã€å¢å¼ºæ–‡æ¡£
2. **çµæ´»é…ç½®**: æ”¯æŒè‡ªå®šä¹‰è½¬æ¢å™¨é“¾
3. **æ˜“äºæ‰©å±•**: æ·»åŠ æ–°è½¬æ¢å™¨åªéœ€å®ç°æ¥å£
4. **å®Œæ•´æµç¨‹**: å½¢æˆ åŠ è½½â†’è§£æâ†’è½¬æ¢â†’åˆ†å‰²â†’å­˜å‚¨ çš„å®Œæ•´å¤„ç†é“¾

è¿™æ˜¯ä¸€ä¸ªå±•ç¤º**å››å±‚ç­–ç•¥æ¨¡å¼ç»„åˆåº”ç”¨**çš„å®Œæ•´æ¡ˆä¾‹ï¼ğŸ‰

**å®Œæ•´æ¶æ„**: åŠ è½½å™¨ + è§£æå™¨ + è½¬æ¢å™¨ + åˆ†å‰²å™¨ = å·¥ä¸šçº§æ–‡æ¡£å¤„ç†ç³»ç»Ÿ
