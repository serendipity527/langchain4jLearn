# æŸ¥è¯¢è·¯ç”±å™¨è®¾è®¡æ¨¡å¼è¯´æ˜

## é‡æ„æ¦‚è¿°

ä½¿ç”¨**ç­–ç•¥æ¨¡å¼**å’Œ**å·¥å‚æ¨¡å¼**å®ç°æŸ¥è¯¢è·¯ç”±å™¨ï¼ˆQueryRouterï¼‰åŠŸèƒ½ï¼Œè¿™æ˜¯RAGç³»ç»Ÿä¸­è´Ÿè´£æ™ºèƒ½é€‰æ‹©æ£€ç´¢å™¨çš„å…³é”®ç»„ä»¶ã€‚

---

## ä»€ä¹ˆæ˜¯ QueryRouterï¼Ÿ

### æ ¸å¿ƒæ¦‚å¿µ

**QueryRouter** è´Ÿè´£å°†æŸ¥è¯¢ï¼ˆQueryï¼‰è·¯ç”±åˆ°ç›¸åº”çš„å†…å®¹æ£€ç´¢å™¨ï¼ˆContentRetrieverï¼‰ã€‚æ ¹æ®æŸ¥è¯¢çš„ç‰¹ç‚¹ï¼Œè·¯ç”±å™¨å¯ä»¥é€‰æ‹©ï¼š
- è·¯ç”±åˆ°**æ‰€æœ‰æ£€ç´¢å™¨**ï¼ˆè·å–å…¨é¢ç»“æœï¼‰
- è·¯ç”±åˆ°**ç‰¹å®šæ£€ç´¢å™¨**ï¼ˆä¼˜åŒ–æ€§èƒ½å’Œå‡†ç¡®æ€§ï¼‰
- è·¯ç”±åˆ°**å¤šä¸ªæ£€ç´¢å™¨**çš„å­é›†ï¼ˆå¹³è¡¡æ€§èƒ½å’Œå¬å›ç‡ï¼‰

### ä¸ºä»€ä¹ˆéœ€è¦ QueryRouterï¼Ÿ

åœ¨å¤æ‚çš„ RAG ç³»ç»Ÿä¸­ï¼Œå¯èƒ½æœ‰å¤šç§ç±»å‹çš„æ£€ç´¢å™¨ï¼š

| æ£€ç´¢å™¨ç±»å‹ | æ•°æ®æº | é€‚ç”¨åœºæ™¯ | æˆæœ¬ |
|----------|--------|---------|------|
| **EmbeddingStore** | å‘é‡æ•°æ®åº“ | ç§æœ‰çŸ¥è¯†åº“æŸ¥è¯¢ | ä½ |
| **WebSearch** | äº’è”ç½‘ | å®æ—¶ä¿¡æ¯ã€æœ€æ–°æ–°é—» | ä¸­ |
| **SqlDatabase** | å…³ç³»æ•°æ®åº“ | ä¸šåŠ¡æ•°æ®ã€ç»Ÿè®¡æŠ¥è¡¨ | ä½ |
| **AzureAISearch** | Azureæœç´¢ | ä¼ä¸šçº§æœç´¢ | é«˜ |

**é—®é¢˜**ï¼šä¸åŒçš„æŸ¥è¯¢åº”è¯¥ä½¿ç”¨ä¸åŒçš„æ£€ç´¢å™¨
- â“ "Spring Boot å¦‚ä½•é…ç½®æ•°æ®æºï¼Ÿ" â†’ EmbeddingStoreï¼ˆçŸ¥è¯†åº“ï¼‰
- â“ "ä»Šå¤©çš„æ–°é—»" â†’ WebSearchï¼ˆå®æ—¶ä¿¡æ¯ï¼‰
- â“ "2023å¹´é”€å”®é¢æ˜¯å¤šå°‘ï¼Ÿ" â†’ SqlDatabaseï¼ˆä¸šåŠ¡æ•°æ®ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ QueryRouter æ™ºèƒ½é€‰æ‹©æœ€åˆé€‚çš„æ£€ç´¢å™¨

---

## æŸ¥è¯¢è·¯ç”±å™¨åœ¨ RAG æµç¨‹ä¸­çš„ä½ç½®

```
ç”¨æˆ·æŸ¥è¯¢
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ QueryTransformerï¼ˆæŸ¥è¯¢è½¬æ¢ï¼‰â”‚
â”‚  ä¼˜åŒ–æŸ¥è¯¢è¡¨è¾¾                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ QueryRouterï¼ˆæŸ¥è¯¢è·¯ç”±å™¨ï¼‰â­  â”‚
â”‚  æ™ºèƒ½é€‰æ‹©æ£€ç´¢å™¨                   â”‚
â”‚  - è·¯ç”±åˆ°æ‰€æœ‰æ£€ç´¢å™¨                â”‚
â”‚  - æˆ–æ™ºèƒ½é€‰æ‹©ç‰¹å®šæ£€ç´¢å™¨             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ ContentRetrieverï¼ˆå†…å®¹æ£€ç´¢ï¼‰â”‚
â”‚  ä»é€‰å®šçš„æ•°æ®æºæ£€ç´¢å†…å®¹             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£ ContentAggregatorï¼ˆå†…å®¹èšåˆï¼‰â”‚
â”‚  èšåˆå¤šä¸ªæ£€ç´¢ç»“æœ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
å¢å¼ºåçš„ Prompt â†’ LLM â†’ å›ç­”
```

---

## è®¾è®¡æ¨¡å¼åº”ç”¨

### ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**ç›®çš„**: å®šä¹‰ä¸€ç³»åˆ—è·¯ç”±ç®—æ³•ï¼Œå°è£…æ¯ä¸ªç®—æ³•ï¼Œä½¿å®ƒä»¬å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚

**å®ç°**:
- **ç­–ç•¥æ¥å£**: `QueryRouterStrategy`
- **å…·ä½“ç­–ç•¥**:
  - `DefaultQueryRouterStrategy` - è·¯ç”±åˆ°æ‰€æœ‰æ£€ç´¢å™¨
  - `LanguageModelQueryRouterStrategy` - ä½¿ç”¨LLMæ™ºèƒ½é€‰æ‹©æ£€ç´¢å™¨

### å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

**å®ç°**:
- **å·¥å‚ç±»**: `QueryRouterFactory`
- **åŠŸèƒ½**: 
  - æä¾›ä¸åŒç±»å‹çš„æŸ¥è¯¢è·¯ç”±å™¨
  - æ£€æŸ¥è·¯ç”±å™¨å¯ç”¨æ€§
  - è·å–æœ€ä½³è·¯ç”±å™¨ç­–ç•¥

---

## æ ¸å¿ƒç±»è¯´æ˜

### 1. QueryRouterTypeï¼ˆæšä¸¾ï¼‰

```java
public enum QueryRouterType {
    DEFAULT,           // é»˜è®¤è·¯ç”±å™¨ - è·¯ç”±åˆ°æ‰€æœ‰æ£€ç´¢å™¨
    LANGUAGE_MODEL,    // è¯­è¨€æ¨¡å‹è·¯ç”±å™¨ - LLMæ™ºèƒ½é€‰æ‹©
    RULE_BASED,        // åŸºäºè§„åˆ™çš„è·¯ç”±å™¨
    ROUND_ROBIN        // è½®è¯¢è·¯ç”±å™¨
}
```

---

### 2. QueryRouterStrategyï¼ˆç­–ç•¥æ¥å£ï¼‰

```java
public interface QueryRouterStrategy {
    // è·å– QueryRouter å®ä¾‹
    QueryRouter getRouter();
    
    // è·å–è·¯ç”±å™¨ç±»å‹
    QueryRouterType getRouterType();
    
    // è·å–æè¿°
    String getDescription();
    
    // æ˜¯å¦å¯ç”¨
    default boolean isEnabled() { return true; }
}
```

---

### 3. å…·ä½“è·¯ç”±å™¨å®ç°

#### DefaultQueryRouterStrategyï¼ˆé»˜è®¤è·¯ç”±å™¨ï¼‰

**ç‰¹ç‚¹**: å°†æŸ¥è¯¢è·¯ç”±åˆ°æ‰€æœ‰å¯ç”¨çš„æ£€ç´¢å™¨

**å®ç°**:
```java
@Component
@RequiredArgsConstructor
public class DefaultQueryRouterStrategy implements QueryRouterStrategy {
    
    private final ContentRetrieverFactory contentRetrieverFactory;
    
    @Override
    public QueryRouter getRouter() {
        // è·å–æ‰€æœ‰å¯ç”¨çš„æ£€ç´¢å™¨
        List<ContentRetriever> retrievers = 
            contentRetrieverFactory.getEnabledStrategies()
                .stream()
                .map(strategy -> strategy.getRetriever())
                .collect(Collectors.toList());
        
        // DefaultQueryRouter ä¼šå°†æŸ¥è¯¢è·¯ç”±åˆ°æ‰€æœ‰æä¾›çš„æ£€ç´¢å™¨
        return new DefaultQueryRouter(retrievers);
    }
}
```

**å·¥ä½œæµç¨‹**:
```
ç”¨æˆ·æŸ¥è¯¢: "Spring Bootå¦‚ä½•é…ç½®æ•°æ®æºï¼Ÿ"
    â†“
DefaultQueryRouter
    â”œâ†’ æ£€ç´¢å™¨1: EmbeddingStore æŸ¥è¯¢
    â”œâ†’ æ£€ç´¢å™¨2: WebSearch æŸ¥è¯¢ï¼ˆå¦‚æœæœ‰ï¼‰
    â””â†’ æ£€ç´¢å™¨3: SqlDatabase æŸ¥è¯¢ï¼ˆå¦‚æœæœ‰ï¼‰
    â†“
èšåˆæ‰€æœ‰æ£€ç´¢ç»“æœ
    â†“
è¿”å›ç»¼åˆç»“æœ
```

**ä¼˜ç‚¹**:
- âœ… ç®€å•ç›´æ¥ï¼Œæ— éœ€é…ç½®
- âœ… è·å–æœ€å…¨é¢çš„ç»“æœ
- âœ… ä¸ä¼šé—æ¼ç›¸å…³ä¿¡æ¯

**ç¼ºç‚¹**:
- âŒ æ€§èƒ½å¼€é”€å¤§ï¼ˆæŸ¥è¯¢æ‰€æœ‰æ£€ç´¢å™¨ï¼‰
- âŒ å¯èƒ½å¼•å…¥å™ªéŸ³ï¼ˆä¸ç›¸å…³çš„ç»“æœï¼‰
- âŒ æˆæœ¬é«˜ï¼ˆå°¤å…¶æ˜¯ä»˜è´¹APIï¼‰

**é€‚ç”¨åœºæ™¯**:
- âœ… åªæœ‰ä¸€ä¸ªæ£€ç´¢å™¨
- âœ… éœ€è¦æœ€å…¨é¢çš„ç»“æœ
- âœ… ä¸ç¡®å®šå“ªä¸ªæ£€ç´¢å™¨æœ€åˆé€‚

---

#### LanguageModelQueryRouterStrategyï¼ˆæ™ºèƒ½è·¯ç”±å™¨ï¼‰â­

**ç‰¹ç‚¹**: ä½¿ç”¨ LLM æ™ºèƒ½é€‰æ‹©æœ€åˆé€‚çš„æ£€ç´¢å™¨

**å®ç°**:
```java
@Component
@ConditionalOnBean(ChatModel.class)
@RequiredArgsConstructor
public class LanguageModelQueryRouterStrategy implements QueryRouterStrategy {
    
    private final ChatModel chatModel;
    private final ContentRetrieverFactory contentRetrieverFactory;
    
    @Override
    public QueryRouter getRouter() {
        // æ„å»ºæ£€ç´¢å™¨æ˜ å°„ï¼šæ£€ç´¢å™¨ â†’ æè¿°
        Map<ContentRetriever, String> retrieverToDescription = new LinkedHashMap<>();
        
        contentRetrieverFactory.getEnabledStrategies().forEach(strategy -> {
            ContentRetriever retriever = strategy.getRetriever();
            String description = buildRetrieverDescription(strategy);
            retrieverToDescription.put(retriever, description);
        });
        
        // åˆ›å»ºè¯­è¨€æ¨¡å‹è·¯ç”±å™¨
        return LanguageModelQueryRouter.builder()
                .chatModel(chatModel)
                .retrieverToDescription(retrieverToDescription)
                .build();
    }
    
    private String buildRetrieverDescription(ContentRetrieverStrategy strategy) {
        switch (strategy.getRetrieverType()) {
            case EMBEDDING_STORE:
                return "ç§æœ‰çŸ¥è¯†åº“æ£€ç´¢å™¨ - ç”¨äºæŸ¥è¯¢å·²å­˜å‚¨çš„æ–‡æ¡£å’ŒçŸ¥è¯†ï¼Œé€‚åˆï¼šäº§å“æ–‡æ¡£ã€æŠ€æœ¯èµ„æ–™ã€å†å²è®°å½•ç­‰é™æ€çŸ¥è¯†æŸ¥è¯¢";
            case WEB_SEARCH:
                return "ç½‘ç»œæœç´¢æ£€ç´¢å™¨ - ç”¨äºæœç´¢äº’è”ç½‘ä¸Šçš„æœ€æ–°ä¿¡æ¯ï¼Œé€‚åˆï¼šå®æ—¶æ–°é—»ã€å½“å‰äº‹ä»¶ã€æœ€æ–°è¶‹åŠ¿ç­‰åŠ¨æ€ä¿¡æ¯æŸ¥è¯¢";
            case SQL_DATABASE:
                return "SQLæ•°æ®åº“æ£€ç´¢å™¨ - ç”¨äºæŸ¥è¯¢ç»“æ„åŒ–æ•°æ®ï¼Œé€‚åˆï¼šé”€å”®æ•°æ®ã€ç”¨æˆ·ä¿¡æ¯ã€ç»Ÿè®¡æŠ¥è¡¨ç­‰ä¸šåŠ¡æ•°æ®æŸ¥è¯¢";
            default:
                return strategy.getDescription();
        }
    }
}
```

**å·¥ä½œæµç¨‹**:
```
ç”¨æˆ·æŸ¥è¯¢: "ä»Šå¤©çš„æ–°é—»"
    â†“
LanguageModelQueryRouter
    â”œâ†’ LLMåˆ†ææŸ¥è¯¢æ„å›¾
    â”‚  åˆ†æï¼š"è¿™æ˜¯å…³äºå®æ—¶æ–°é—»çš„æŸ¥è¯¢"
    â”‚
    â”œâ†’ è¯„ä¼°å¯ç”¨æ£€ç´¢å™¨
    â”‚  - ç§æœ‰çŸ¥è¯†åº“ï¼šä¸é€‚åˆï¼ˆå†å²æ•°æ®ï¼‰
    â”‚  - ç½‘ç»œæœç´¢ï¼šâœ“ é€‚åˆï¼ˆå®æ—¶ä¿¡æ¯ï¼‰
    â”‚  - SQLæ•°æ®åº“ï¼šä¸é€‚åˆï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰
    â”‚
    â””â†’ é€‰æ‹©æœ€åˆé€‚çš„æ£€ç´¢å™¨
       é€‰æ‹©ï¼šWebSearch
    â†“
ä»…æŸ¥è¯¢ WebSearch
    â†“
è¿”å›æœ€æ–°æ–°é—»
```

**LLM å†³ç­–ç¤ºä¾‹**:

**æŸ¥è¯¢1**: "Spring Bootå¦‚ä½•é…ç½®æ•°æ®æºï¼Ÿ"
- **LLMåˆ†æ**: æŠ€æœ¯çŸ¥è¯†æŸ¥è¯¢
- **é€‰æ‹©**: EmbeddingStoreï¼ˆçŸ¥è¯†åº“ï¼‰
- **ç†ç”±**: è¿™æ˜¯é™æ€æŠ€æœ¯çŸ¥è¯†ï¼Œåº”è¯¥åœ¨æ–‡æ¡£ä¸­

**æŸ¥è¯¢2**: "ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
- **LLMåˆ†æ**: å®æ—¶ä¿¡æ¯æŸ¥è¯¢
- **é€‰æ‹©**: WebSearchï¼ˆç½‘ç»œæœç´¢ï¼‰
- **ç†ç”±**: éœ€è¦æœ€æ–°çš„å®æ—¶æ•°æ®

**æŸ¥è¯¢3**: "2023å¹´é”€å”®é¢æœ€é«˜çš„äº§å“æ˜¯ä»€ä¹ˆï¼Ÿ"
- **LLMåˆ†æ**: ä¸šåŠ¡æ•°æ®æŸ¥è¯¢
- **é€‰æ‹©**: SqlDatabaseï¼ˆSQLæ•°æ®åº“ï¼‰
- **ç†ç”±**: éœ€è¦æŸ¥è¯¢ç»“æ„åŒ–çš„ä¸šåŠ¡æ•°æ®

**ä¼˜ç‚¹**:
- âœ… æ™ºèƒ½é€‰æ‹©ï¼Œæé«˜å‡†ç¡®æ€§
- âœ… ä¼˜åŒ–æ€§èƒ½ï¼ˆåªæŸ¥è¯¢ç›¸å…³æ£€ç´¢å™¨ï¼‰
- âœ… é™ä½æˆæœ¬ï¼ˆå‡å°‘APIè°ƒç”¨ï¼‰
- âœ… å‡å°‘å™ªéŸ³ï¼ˆé¿å…ä¸ç›¸å…³ç»“æœï¼‰

**ç¼ºç‚¹**:
- âŒ éœ€è¦ ChatModelï¼ˆé¢å¤–æˆæœ¬ï¼‰
- âŒ å¢åŠ å»¶è¿Ÿï¼ˆLLMæ¨ç†æ—¶é—´ï¼‰
- âŒ å¯èƒ½è¯¯åˆ¤ï¼ˆLLMä¸æ€»æ˜¯æ­£ç¡®ï¼‰

**é€‚ç”¨åœºæ™¯**:
- âœ… æœ‰å¤šä¸ªä¸åŒç±»å‹çš„æ£€ç´¢å™¨
- âœ… éœ€è¦ä¼˜åŒ–æ€§èƒ½å’Œæˆæœ¬
- âœ… æŸ¥è¯¢ç±»å‹å¤šæ ·åŒ–
- âœ… æœ‰å¯ç”¨çš„ ChatModel

---

### 4. QueryRouterFactoryï¼ˆå·¥å‚ç±»ï¼‰

```java
@Component
@RequiredArgsConstructor
public class QueryRouterFactory {
    private final List<QueryRouterStrategy> routerStrategies;
    
    // è·å–æŒ‡å®šç±»å‹çš„è·¯ç”±å™¨
    public Optional<QueryRouterStrategy> getStrategy(QueryRouterType type);
    
    // è·å–é»˜è®¤è·¯ç”±å™¨
    public QueryRouterStrategy getDefaultStrategy();
    
    // è·å–è¯­è¨€æ¨¡å‹è·¯ç”±å™¨ï¼ˆå¯èƒ½ä¸å¯ç”¨ï¼‰
    public Optional<QueryRouterStrategy> getLanguageModelStrategy();
    
    // è·å–æœ€ä½³è·¯ç”±å™¨ç­–ç•¥
    // ä¼˜å…ˆä½¿ç”¨è¯­è¨€æ¨¡å‹è·¯ç”±å™¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤è·¯ç”±å™¨
    public QueryRouterStrategy getBestStrategy();
    
    // åˆ—å‡ºæ‰€æœ‰å¯ç”¨è·¯ç”±å™¨
    public Map<QueryRouterType, String> listAvailableRouters();
}
```

---

## é…ç½®è¯´æ˜

### application.properties

```properties
# RAG æŸ¥è¯¢è·¯ç”±å™¨é…ç½®
# æ˜¯å¦å¯ç”¨æ™ºèƒ½æŸ¥è¯¢è·¯ç”±å™¨ï¼ˆéœ€è¦ ChatModelï¼‰
rag.query.router.enabled=false
# è·¯ç”±å™¨ç±»å‹ï¼šDEFAULTï¼ˆè·¯ç”±åˆ°æ‰€æœ‰æ£€ç´¢å™¨ï¼‰ã€LANGUAGE_MODELï¼ˆLLMæ™ºèƒ½é€‰æ‹©ï¼‰
rag.query.router.type=DEFAULT
```

### å‚æ•°è¯´æ˜

| å‚æ•° | å«ä¹‰ | å¯é€‰å€¼ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|--------|--------|------|
| **rag.query.router.enabled** | å¯ç”¨æ™ºèƒ½è·¯ç”±å™¨ | true/false | false | éœ€è¦ChatModel |
| **rag.query.router.type** | è·¯ç”±å™¨ç±»å‹ | DEFAULT / LANGUAGE_MODEL | DEFAULT | é€‰æ‹©è·¯ç”±ç­–ç•¥ |

---

## å®Œæ•´çš„ RAG ç»„ä»¶é›†æˆ

### EnhancedRetrievalAugmentorStrategy

æ–°å¢çš„å¢å¼ºå‹æ£€ç´¢å¢å¼ºå™¨ï¼Œé›†æˆæŸ¥è¯¢è·¯ç”±å™¨ï¼š

```java
@Component
@RequiredArgsConstructor
public class EnhancedRetrievalAugmentorStrategy implements RetrievalAugmentorStrategy {
    
    private final QueryTransformerFactory queryTransformerFactory;
    private final QueryRouterFactory queryRouterFactory;
    
    @Value("${rag.query.transformer.enabled:false}")
    private boolean queryTransformerEnabled;
    
    @Value("${rag.query.router.enabled:false}")
    private boolean queryRouterEnabled;
    
    @Override
    public RetrievalAugmentor getAugmentor() {
        var builder = DefaultRetrievalAugmentor.builder();
        
        // 1. æ·»åŠ æŸ¥è¯¢è½¬æ¢å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (queryTransformerEnabled) {
            Optional<QueryTransformer> transformer = getQueryTransformer();
            transformer.ifPresent(builder::queryTransformer);
        }
        
        // 2. æ·»åŠ æŸ¥è¯¢è·¯ç”±å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰â­ æ–°å¢
        if (queryRouterEnabled) {
            Optional<QueryRouter> router = getQueryRouter();
            router.ifPresent(builder::queryRouter);
        } else {
            // ä½¿ç”¨é»˜è®¤è·¯ç”±å™¨
            QueryRouter defaultRouter = queryRouterFactory.getDefaultStrategy().getRouter();
            builder.queryRouter(defaultRouter);
        }
        
        return builder.build();
    }
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºæœ¬ä½¿ç”¨ï¼ˆé»˜è®¤è·¯ç”±å™¨ï¼‰

```java
@Autowired
private QueryRouterFactory queryRouterFactory;
@Autowired
private ContentRetrieverFactory contentRetrieverFactory;

// è·å–é»˜è®¤è·¯ç”±å™¨
QueryRouterStrategy routerStrategy = queryRouterFactory.getDefaultStrategy();
QueryRouter router = routerStrategy.getRouter();

// åˆ›å»º RetrievalAugmentor
RetrievalAugmentor augmentor = DefaultRetrievalAugmentor.builder()
        .queryRouter(router)
        .build();

Assistant assistant = AiServices.builder(Assistant.class)
        .chatLanguageModel(chatModel)
        .retrievalAugmentor(augmentor)
        .build();

// æŸ¥è¯¢ä¼šè¢«è·¯ç”±åˆ°æ‰€æœ‰æ£€ç´¢å™¨
String answer = assistant.chat("Spring Bootå¦‚ä½•é…ç½®æ•°æ®æºï¼Ÿ");
```

---

### ç¤ºä¾‹2: æ™ºèƒ½è·¯ç”±å™¨ï¼ˆå¤šæ•°æ®æºï¼‰

**åœºæ™¯**: æœ‰ä¸‰ç§æ£€ç´¢å™¨ï¼šçŸ¥è¯†åº“ã€ç½‘ç»œæœç´¢ã€SQLæ•°æ®åº“

**é…ç½®**:
```properties
# å¯ç”¨æ™ºèƒ½æŸ¥è¯¢è·¯ç”±å™¨
rag.query.router.enabled=true
rag.query.router.type=LANGUAGE_MODEL
```

**å®ç°**:
```java
@Autowired
private QueryRouterFactory queryRouterFactory;

// è·å–æ™ºèƒ½è·¯ç”±å™¨
QueryRouterStrategy routerStrategy = queryRouterFactory.getBestStrategy();
QueryRouter router = routerStrategy.getRouter();

// åˆ›å»º RetrievalAugmentor
RetrievalAugmentor augmentor = DefaultRetrievalAugmentor.builder()
        .queryRouter(router)
        .build();

Assistant assistant = AiServices.builder(Assistant.class)
        .chatLanguageModel(chatModel)
        .retrievalAugmentor(augmentor)
        .build();

// ä¸åŒçš„æŸ¥è¯¢ä¼šè¢«æ™ºèƒ½è·¯ç”±åˆ°ä¸åŒçš„æ£€ç´¢å™¨
String answer1 = assistant.chat("Spring Booté…ç½®æ•°æ®æºï¼Ÿ");
// â†’ è·¯ç”±åˆ° EmbeddingStoreï¼ˆçŸ¥è¯†åº“ï¼‰

String answer2 = assistant.chat("ä»Šå¤©çš„æ–°é—»");
// â†’ è·¯ç”±åˆ° WebSearchï¼ˆç½‘ç»œæœç´¢ï¼‰

String answer3 = assistant.chat("2023å¹´é”€å”®é¢");
// â†’ è·¯ç”±åˆ° SqlDatabaseï¼ˆæ•°æ®åº“ï¼‰
```

---

### ç¤ºä¾‹3: å®Œæ•´çš„å¢å¼ºå‹æ£€ç´¢å™¨

**ä½¿ç”¨ EnhancedRetrievalAugmentorStrategy**ï¼Œé›†æˆæŸ¥è¯¢è½¬æ¢å™¨å’ŒæŸ¥è¯¢è·¯ç”±å™¨ï¼š

**é…ç½®**:
```properties
# å¯ç”¨æŸ¥è¯¢è½¬æ¢å™¨
rag.query.transformer.enabled=true

# å¯ç”¨æ™ºèƒ½æŸ¥è¯¢è·¯ç”±å™¨
rag.query.router.enabled=true
```

**å®ç°**:
```java
@Autowired
private RetrievalAugmentorFactory augmentorFactory;

// è·å–å¢å¼ºå‹æ£€ç´¢å¢å¼ºå™¨ï¼ˆè‡ªåŠ¨åŒ…å«æŸ¥è¯¢è½¬æ¢å™¨å’Œè·¯ç”±å™¨ï¼‰
RetrievalAugmentorStrategy strategy = augmentorFactory.getStrategy(
    RetrievalAugmentorType.ADVANCED
).orElseThrow();

RetrievalAugmentor augmentor = strategy.getAugmentor();

Assistant assistant = AiServices.builder(Assistant.class)
        .chatLanguageModel(chatModel)
        .retrievalAugmentor(augmentor)
        .build();

// å®Œæ•´çš„å¤„ç†é“¾ï¼š
// ç”¨æˆ·æŸ¥è¯¢ â†’ æŸ¥è¯¢è½¬æ¢ â†’ æ™ºèƒ½è·¯ç”± â†’ æ£€ç´¢ â†’ å›ç­”
String answer = assistant.chat("Spring Booté…ç½®æ•°æ®æºï¼Ÿ");
```

**å¤„ç†æµç¨‹**:
```
ç”¨æˆ·æŸ¥è¯¢: "Spring Booté…ç½®æ•°æ®æºï¼Ÿ"
    â†“
1ï¸âƒ£ QueryTransformerï¼ˆæŸ¥è¯¢è½¬æ¢ï¼‰
   ä¼˜åŒ–æŸ¥è¯¢: "Spring Boot æ•°æ®æºé…ç½®æ–¹æ³•"
    â†“
2ï¸âƒ£ LanguageModelQueryRouterï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰
   LLMåˆ†æ: "è¿™æ˜¯æŠ€æœ¯çŸ¥è¯†æŸ¥è¯¢"
   é€‰æ‹©: EmbeddingStoreï¼ˆçŸ¥è¯†åº“ï¼‰
    â†“
3ï¸âƒ£ EmbeddingStoreContentRetrieverï¼ˆå†…å®¹æ£€ç´¢ï¼‰
   æ£€ç´¢ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
    â†“
4ï¸âƒ£ èšåˆç»“æœå¹¶æ³¨å…¥åˆ° Prompt
    â†“
5ï¸âƒ£ LLM ç”Ÿæˆå›ç­”
    â†“
ç”¨æˆ·æ”¶åˆ°ç­”æ¡ˆ
```

---

## å¯¹æ¯”ï¼šDefaultQueryRouter vs LanguageModelQueryRouter

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | DefaultQueryRouter | LanguageModelQueryRouter |
|-----|-------------------|-------------------------|
| **å»¶è¿Ÿ** | é«˜ï¼ˆæŸ¥è¯¢æ‰€æœ‰æ£€ç´¢å™¨ï¼‰ | ä½ï¼ˆåªæŸ¥è¯¢ç›¸å…³æ£€ç´¢å™¨ï¼‰ |
| **æˆæœ¬** | é«˜ï¼ˆæ‰€æœ‰APIè°ƒç”¨ï¼‰ | ä½ï¼ˆå‡å°‘APIè°ƒç”¨ï¼‰ |
| **å‡†ç¡®æ€§** | ä¸­ï¼ˆå¯èƒ½æœ‰å™ªéŸ³ï¼‰ | é«˜ï¼ˆç²¾å‡†é€‰æ‹©ï¼‰ |
| **å¬å›ç‡** | é«˜ï¼ˆå…¨é¢æœç´¢ï¼‰ | ä¸­ï¼ˆä¾èµ–LLMåˆ¤æ–­ï¼‰ |
| **é…ç½®** | ç®€å•ï¼ˆæ— éœ€é…ç½®ï¼‰ | éœ€è¦ChatModel |

### é€‚ç”¨åœºæ™¯å¯¹æ¯”

| åœºæ™¯ | æ¨èè·¯ç”±å™¨ | åŸå›  |
|-----|----------|------|
| åªæœ‰1ä¸ªæ£€ç´¢å™¨ | DefaultQueryRouter | æ— éœ€é€‰æ‹© |
| å¤šä¸ªåŒç±»å‹æ£€ç´¢å™¨ | DefaultQueryRouter | å…¨é¢æœç´¢æ›´å¥½ |
| å¤šä¸ªä¸åŒç±»å‹æ£€ç´¢å™¨ | LanguageModelQueryRouter â­ | æ™ºèƒ½é€‰æ‹©æ›´é«˜æ•ˆ |
| æˆæœ¬æ•æ„Ÿ | LanguageModelQueryRouter | å‡å°‘APIè°ƒç”¨ |
| æ€§èƒ½ä¼˜å…ˆ | LanguageModelQueryRouter | å‡å°‘æ£€ç´¢æ—¶é—´ |
| å¬å›ç‡ä¼˜å…ˆ | DefaultQueryRouter | å…¨é¢æœç´¢ |

---

## æ‰©å±•ï¼šè‡ªå®šä¹‰è·¯ç”±å™¨

### åŸºäºè§„åˆ™çš„è·¯ç”±å™¨

**åœºæ™¯**: ä¸æƒ³ä½¿ç”¨LLMï¼Œä½†æƒ³æ ¹æ®è§„åˆ™è·¯ç”±

**ç¤ºä¾‹å®ç°**:
```java
@Component
public class RuleBasedQueryRouterStrategy implements QueryRouterStrategy {
    
    @Override
    public QueryRouter getRouter() {
        return query -> {
            String text = query.text().toLowerCase();
            
            // è§„åˆ™1: åŒ…å«"ä»Šå¤©"ã€"æœ€æ–°" â†’ WebSearch
            if (text.contains("ä»Šå¤©") || text.contains("æœ€æ–°")) {
                return List.of(webSearchRetriever);
            }
            
            // è§„åˆ™2: åŒ…å«"é”€å”®"ã€"ç»Ÿè®¡" â†’ SqlDatabase
            if (text.contains("é”€å”®") || text.contains("ç»Ÿè®¡")) {
                return List.of(sqlDatabaseRetriever);
            }
            
            // é»˜è®¤: EmbeddingStore
            return List.of(embeddingStoreRetriever);
        };
    }
}
```

---

## æœ€ä½³å®è·µå»ºè®®

### 1. é€‰æ‹©åˆé€‚çš„è·¯ç”±å™¨

| åœºæ™¯ | æ¨èè·¯ç”±å™¨ | é…ç½® |
|-----|----------|------|
| å•ä¸€æ•°æ®æº | DefaultQueryRouter | `rag.query.router.enabled=false` |
| å¤šä¸ªä¸åŒç±»å‹æ•°æ®æº | LanguageModelQueryRouter | `rag.query.router.enabled=true` |
| ç®€å•è§„åˆ™è·¯ç”± | RuleBasedQueryRouter | è‡ªå®šä¹‰å®ç° |

### 2. ä¼˜åŒ– LLM è·¯ç”±æ€§èƒ½

**æ–¹æ³•1**: ç¼“å­˜è·¯ç”±å†³ç­–
```java
// å¯¹äºç›¸åŒæˆ–ç›¸ä¼¼çš„æŸ¥è¯¢ï¼Œç¼“å­˜è·¯ç”±ç»“æœ
Map<String, ContentRetriever> routingCache = new ConcurrentHashMap<>();
```

**æ–¹æ³•2**: ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹
```java
// ä½¿ç”¨è½»é‡çº§æ¨¡å‹è¿›è¡Œè·¯ç”±å†³ç­–
ChatModel fastModel = OpenAiChatModel.builder()
        .modelName("gpt-3.5-turbo")  // æ›´å¿«æ›´ä¾¿å®œ
        .build();
```

### 3. ç›‘æ§è·¯ç”±è´¨é‡

**æŒ‡æ ‡**:
- è·¯ç”±å†³ç­–æ—¶é—´
- è·¯ç”±é€‰æ‹©åˆ†å¸ƒï¼ˆå„æ£€ç´¢å™¨ä½¿ç”¨é¢‘ç‡ï¼‰
- è·¯ç”±å‡†ç¡®æ€§ï¼ˆäººå·¥è¯„ä¼°ï¼‰

---

## æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **æ™ºèƒ½æ£€ç´¢å™¨é€‰æ‹©**: æ ¹æ®æŸ¥è¯¢æ„å›¾é€‰æ‹©æœ€åˆé€‚çš„æ£€ç´¢å™¨
2. **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘ä¸å¿…è¦çš„æ£€ç´¢è°ƒç”¨
3. **æˆæœ¬ä¼˜åŒ–**: é™ä½APIè°ƒç”¨æˆæœ¬
4. **æé«˜å‡†ç¡®æ€§**: å‡å°‘ä¸ç›¸å…³ç»“æœçš„å™ªéŸ³

### RAGç³»ç»Ÿå®Œæ•´åº¦

```
æŸ¥è¯¢å¤„ç†é˜¶æ®µï¼ˆåœ¨çº¿ï¼‰:
ç”¨æˆ·æŸ¥è¯¢
    â†“
1ï¸âƒ£ QueryTransformer    â†’ æŸ¥è¯¢ä¼˜åŒ–
2ï¸âƒ£ QueryRouter â­       â†’ æ™ºèƒ½è·¯ç”±ï¼ˆæ–°å¢ï¼‰
3ï¸âƒ£ ContentRetriever    â†’ å†…å®¹æ£€ç´¢
4ï¸âƒ£ RetrievalAugmentor  â†’ æ£€ç´¢å¢å¼º
    â†“
LLM â†’ å›ç­”
```

**QueryRouteræ˜¯RAGç³»ç»Ÿçš„æ™ºèƒ½è°ƒåº¦ä¸­å¿ƒï¼** å®ƒè´Ÿè´£å°†æŸ¥è¯¢è·¯ç”±åˆ°æœ€åˆé€‚çš„æ£€ç´¢å™¨ï¼Œæ˜¯ä¼˜åŒ–RAGç³»ç»Ÿæ€§èƒ½å’Œå‡†ç¡®æ€§çš„å…³é”®ï¼ğŸ¯
