# æ–‡æ¡£å¤„ç†ç³»ç»Ÿè®¾è®¡æ¨¡å¼é‡æ„è¯´æ˜

## é‡æ„æ¦‚è¿°

æœ¬æ¬¡é‡æ„ä½¿ç”¨**ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰**å’Œ**å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰**å¯¹æ•´ä¸ªæ–‡æ¡£å¤„ç†æµç¨‹è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼š

1. **æ–‡æ¡£åŠ è½½å™¨é‡æ„**: å°†åŠ è½½é€»è¾‘ä» `DocumentService` ä¸­è§£è€¦
2. **æ–‡æ¡£è§£æå™¨é‡æ„**: å°†è§£æé€»è¾‘ä»åŠ è½½å™¨ä¸­åˆ†ç¦»ï¼Œå®ç°æ™ºèƒ½é€‰æ‹©
3. **æ–‡æ¡£åˆ†å‰²å™¨é‡æ„**: æä¾›å¤šç§åˆ†å‰²ç­–ç•¥ï¼Œæ”¯æŒåŠ¨æ€é€‰æ‹©
4. **æ–‡æ¡£è½¬æ¢å™¨é‡æ„**: å®ç°æ–‡æ¡£é¢„å¤„ç†èƒ½åŠ›ï¼ŒåŒ…æ‹¬æ¸…ç†ã€ç­›é€‰ã€å¢å¼ºç­‰
5. **æ–‡æœ¬æ®µè½¬æ¢å™¨é‡æ„**: åœ¨æ–‡æœ¬æ®µçº§åˆ«æ·»åŠ æ ‡é¢˜/æ‘˜è¦ï¼Œæé«˜æ£€ç´¢æ•ˆæœï¼ˆæ–°å¢ï¼‰

> **ğŸ“š è¯¦ç»†æ–‡æ¡£**: 
> - åŠ è½½å™¨è®¾è®¡è¯´æ˜: æœ¬æ–‡æ¡£
> - è§£æå™¨è®¾è®¡è¯´æ˜: `æ–‡æ¡£è§£æå™¨è®¾è®¡æ¨¡å¼è¯´æ˜.md`
> - åˆ†å‰²å™¨è®¾è®¡è¯´æ˜: `æ–‡æ¡£åˆ†å‰²å™¨è®¾è®¡æ¨¡å¼è¯´æ˜.md`
> - è½¬æ¢å™¨è®¾è®¡è¯´æ˜: `æ–‡æ¡£è½¬æ¢å™¨è®¾è®¡æ¨¡å¼è¯´æ˜.md`
> - æ–‡æœ¬æ®µè½¬æ¢å™¨è®¾è®¡è¯´æ˜: `æ–‡æœ¬æ®µè½¬æ¢å™¨è®¾è®¡æ¨¡å¼è¯´æ˜.md`

---

## è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**ç›®çš„**: å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼ˆåŠ è½½ç­–ç•¥ï¼‰ï¼ŒæŠŠå®ƒä»¬ä¸€ä¸ªä¸ªå°è£…èµ·æ¥ï¼Œå¹¶ä¸”ä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚

**å®ç°**:
- **ç­–ç•¥æ¥å£**: `DocumentLoaderStrategy`
- **å…·ä½“ç­–ç•¥**:
  - `FileSystemDocumentLoaderStrategy` - æ–‡ä»¶ç³»ç»ŸåŠ è½½ç­–ç•¥
  - `UrlDocumentLoaderStrategy` - URLåŠ è½½ç­–ç•¥
  - `ClasspathDocumentLoaderStrategy` - ç±»è·¯å¾„åŠ è½½ç­–ç•¥

### 2. å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

**ç›®çš„**: æä¾›ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å·¥å‚ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç­–ç•¥ç±»ã€‚

**å®ç°**:
- **å·¥å‚ç±»**: `DocumentLoaderFactory`
- **åŠŸèƒ½**: æ ¹æ® `DocumentLoaderType` æšä¸¾è¿”å›å¯¹åº”çš„åŠ è½½å™¨ç­–ç•¥

---

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  RagController                       â”‚
â”‚  (è°ƒç”¨DocumentServiceå¤„ç†æ–‡æ¡£æ‘„å–è¯·æ±‚)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               DocumentService                        â”‚
â”‚  â€¢ è´Ÿè´£æ–‡æ¡£æ‘„å–çš„ä¸»è¦ä¸šåŠ¡é€»è¾‘                         â”‚
â”‚  â€¢ å§”æ‰˜åŠ è½½é€»è¾‘ç»™DocumentLoaderFactory                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           DocumentLoaderFactory                      â”‚
â”‚  â€¢ æ ¹æ®DocumentLoaderTypeé€‰æ‹©å¯¹åº”çš„åŠ è½½å™¨ç­–ç•¥         â”‚
â”‚  â€¢ Springè‡ªåŠ¨æ³¨å…¥æ‰€æœ‰ç­–ç•¥å®ç°                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚FileSystem    â”‚ â”‚Url           â”‚ â”‚Classpath     â”‚
â”‚Loader        â”‚ â”‚Loader        â”‚ â”‚Loader        â”‚
â”‚Strategy      â”‚ â”‚Strategy      â”‚ â”‚Strategy      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         å®ç° DocumentLoaderStrategy æ¥å£
```

---

## æ ¸å¿ƒç±»è¯´æ˜

### 1. DocumentLoaderStrategyï¼ˆç­–ç•¥æ¥å£ï¼‰

```java
public interface DocumentLoaderStrategy {
    // åŠ è½½å•ä¸ªæ–‡æ¡£
    Document loadDocument(String sourcePath);
    
    // æ‰¹é‡åŠ è½½æ–‡æ¡£
    List<Document> loadDocuments(String sourcePath);
    
    // è·å–åŠ è½½å™¨ç±»å‹
    DocumentLoaderType getLoaderType();
}
```

**èŒè´£**: å®šä¹‰æ–‡æ¡£åŠ è½½çš„ç»Ÿä¸€è¡Œä¸ºè§„èŒƒ

---

### 2. DocumentLoaderTypeï¼ˆæšä¸¾ï¼‰

```java
public enum DocumentLoaderType {
    FILE_SYSTEM,  // æ–‡ä»¶ç³»ç»ŸåŠ è½½å™¨
    URL,          // URLåŠ è½½å™¨
    CLASSPATH     // ç±»è·¯å¾„åŠ è½½å™¨
}
```

**èŒè´£**: å®šä¹‰æ”¯æŒçš„åŠ è½½å™¨ç±»å‹

---

### 3. å…·ä½“ç­–ç•¥å®ç°

#### FileSystemDocumentLoaderStrategy
- **åŠŸèƒ½**: ä»æœ¬åœ°æ–‡ä»¶ç³»ç»ŸåŠ è½½æ–‡æ¡£
- **ç‰¹æ€§**: 
  - è‡ªåŠ¨è¯†åˆ«PDFæ–‡ä»¶å¹¶ä½¿ç”¨ `ApachePdfBoxDocumentParser`
  - å…¶ä»–æ–‡ä»¶ä½¿ç”¨ `TextDocumentParser`
  - æ”¯æŒå•æ–‡ä»¶å’Œç›®å½•æ‰¹é‡åŠ è½½

#### UrlDocumentLoaderStrategy
- **åŠŸèƒ½**: ä»URLåŠ è½½æ–‡æ¡£
- **ç‰¹æ€§**: 
  - ä½¿ç”¨ langchain4j çš„ `UrlDocumentLoader`
  - è‡ªåŠ¨å¤„ç†ç½‘ç»œè¯·æ±‚

#### ClasspathDocumentLoaderStrategy
- **åŠŸèƒ½**: ä»ç±»è·¯å¾„ï¼ˆresourcesç›®å½•ï¼‰åŠ è½½æ–‡æ¡£
- **ç‰¹æ€§**: 
  - ä»é¡¹ç›®å†…åµŒèµ„æºåŠ è½½
  - é€‚åˆé¢„æ‰“åŒ…çš„æ–‡æ¡£

---

### 4. DocumentLoaderFactoryï¼ˆå·¥å‚ç±»ï¼‰

```java
@Component
@RequiredArgsConstructor
public class DocumentLoaderFactory {
    // Springè‡ªåŠ¨æ³¨å…¥æ‰€æœ‰ç­–ç•¥å®ç°
    private final List<DocumentLoaderStrategy> loaderStrategies;
    
    // æ ¹æ®ç±»å‹è·å–åŠ è½½å™¨
    public DocumentLoaderStrategy getLoader(DocumentLoaderType loaderType) {
        return loaderStrategies.stream()
                .filter(strategy -> strategy.getLoaderType() == loaderType)
                .findFirst()
                .orElseThrow(...);
    }
}
```

**èŒè´£**: 
- ç®¡ç†æ‰€æœ‰åŠ è½½å™¨ç­–ç•¥å®ä¾‹
- æ ¹æ®ç±»å‹è¿”å›å¯¹åº”çš„ç­–ç•¥
- åˆ©ç”¨Springçš„ä¾èµ–æ³¨å…¥è‡ªåŠ¨æ”¶é›†æ‰€æœ‰ç­–ç•¥å®ç°

---

### 5. DocumentServiceï¼ˆé‡æ„åï¼‰

**é‡æ„å‰**:
- åŒ…å«å¤§é‡çš„æ–‡æ¡£åŠ è½½é€»è¾‘
- æ¯ç§åŠ è½½æ–¹å¼éƒ½æœ‰ç‹¬ç«‹çš„å®ç°
- ä»£ç å†—ä½™ï¼Œéš¾ä»¥ç»´æŠ¤

**é‡æ„å**:
```java
public void ingestDocumentFromFile(String filePath) {
    DocumentLoaderStrategy loader = loaderFactory.getLoader(DocumentLoaderType.FILE_SYSTEM);
    Document document = loader.loadDocument(filePath);
    ingestDocuments(List.of(document));
}
```

**ä¼˜åŠ¿**:
- ä»£ç ç®€æ´ï¼Œæ¯ä¸ªæ–¹æ³•åªæœ‰3-4è¡Œ
- åŠ è½½é€»è¾‘å§”æ‰˜ç»™ä¸“é—¨çš„ç­–ç•¥ç±»
- ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™

---

## é‡æ„ä¼˜åŠ¿

### 1. **å¼€é—­åŸåˆ™ï¼ˆOpen-Closed Principleï¼‰**
- âœ… å¯¹æ‰©å±•å¼€æ”¾ï¼šæ·»åŠ æ–°çš„åŠ è½½å™¨åªéœ€å®ç° `DocumentLoaderStrategy` æ¥å£
- âœ… å¯¹ä¿®æ”¹å…³é—­ï¼šæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 

### 2. **å•ä¸€èŒè´£åŸåˆ™ï¼ˆSingle Responsibility Principleï¼‰**
- âœ… `DocumentService` ä¸“æ³¨äºæ–‡æ¡£æ‘„å–ä¸šåŠ¡é€»è¾‘
- âœ… å„ç­–ç•¥ç±»ä¸“æ³¨äºå„è‡ªçš„åŠ è½½é€»è¾‘
- âœ… å·¥å‚ç±»ä¸“æ³¨äºç­–ç•¥çš„ç®¡ç†å’Œåˆ›å»º

### 3. **ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDependency Inversion Principleï¼‰**
- âœ… `DocumentService` ä¾èµ–äºæŠ½è±¡ï¼ˆ`DocumentLoaderStrategy`ï¼‰è€Œéå…·ä½“å®ç°
- âœ… é€šè¿‡å·¥å‚è·å–ç­–ç•¥ï¼Œé™ä½è€¦åˆ

### 4. **å¯ç»´æŠ¤æ€§**
- âœ… ä»£ç ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜
- âœ… æ¯ä¸ªç±»çš„ä»£ç é‡å‡å°‘ï¼Œæ˜“äºç†è§£
- âœ… ä¿®æ”¹æŸä¸ªåŠ è½½å™¨ä¸å½±å“å…¶ä»–éƒ¨åˆ†

### 5. **å¯æ‰©å±•æ€§**
- âœ… æ·»åŠ æ–°çš„åŠ è½½å™¨ç±»å‹åªéœ€ï¼š
  1. åˆ›å»ºæ–°çš„ç­–ç•¥å®ç°ç±»
  2. åœ¨æšä¸¾ä¸­æ·»åŠ æ–°ç±»å‹
  3. Springè‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€ä¿®æ”¹å·¥å‚ç±»

### 6. **å¯æµ‹è¯•æ€§**
- âœ… æ¯ä¸ªç­–ç•¥å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- âœ… å¯ä»¥è½»æ¾ mock ç­–ç•¥è¿›è¡Œå•å…ƒæµ‹è¯•
- âœ… å·¥å‚ç±»çš„æµ‹è¯•æ›´åŠ ç®€å•

---

## å¦‚ä½•æ‰©å±•æ–°çš„åŠ è½½å™¨

å‡è®¾è¦æ·»åŠ ä¸€ä¸ª **æ•°æ®åº“åŠ è½½å™¨**ï¼š

### æ­¥éª¤1: æ·»åŠ æšä¸¾ç±»å‹
```java
public enum DocumentLoaderType {
    FILE_SYSTEM,
    URL,
    CLASSPATH,
    DATABASE  // æ–°å¢
}
```

### æ­¥éª¤2: åˆ›å»ºç­–ç•¥å®ç°
```java
@Component
public class DatabaseDocumentLoaderStrategy implements DocumentLoaderStrategy {
    
    @Autowired
    private DocumentRepository documentRepository;
    
    @Override
    public Document loadDocument(String sourcePath) {
        // ä»æ•°æ®åº“åŠ è½½é€»è¾‘
        return documentRepository.findById(sourcePath)...;
    }
    
    @Override
    public List<Document> loadDocuments(String sourcePath) {
        // æ‰¹é‡åŠ è½½é€»è¾‘
        return documentRepository.findAll()...;
    }
    
    @Override
    public DocumentLoaderType getLoaderType() {
        return DocumentLoaderType.DATABASE;
    }
}
```

### æ­¥éª¤3: å®Œæˆï¼
- âœ… Spring è‡ªåŠ¨æ³¨å…¥æ–°ç­–ç•¥åˆ°å·¥å‚
- âœ… æ— éœ€ä¿®æ”¹ `DocumentService`
- âœ… æ— éœ€ä¿®æ”¹ `DocumentLoaderFactory`
- âœ… å¯ä»¥ç«‹å³ä½¿ç”¨

---

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨ä»£ç ä¸­ä½¿ç”¨

```java
@Autowired
private DocumentService documentService;

// æ–¹å¼1: ä½¿ç”¨å…·ä½“æ–¹æ³•
documentService.ingestDocumentFromFile("C:/docs/example.pdf");
documentService.ingestDocumentFromUrl("https://example.com/doc.txt");
documentService.ingestDocumentFromClasspath("docs/readme.md");

// æ–¹å¼2: ä½¿ç”¨åŠ¨æ€æ–¹æ³•ï¼ˆæ¨èï¼‰
documentService.ingestDocumentByLoaderType(
    DocumentLoaderType.FILE_SYSTEM, 
    "C:/docs/example.pdf"
);
```

### é€šè¿‡ API ä½¿ç”¨

```bash
# åŠ¨æ€åŠ è½½æ¥å£
curl -X POST http://localhost:8080/api/rag/ingest-dynamic \
  -H "Content-Type: application/json" \
  -d '{
    "loaderType": "FILE_SYSTEM",
    "sourcePath": "C:/documents/example.pdf"
  }'
```

---

## é¡¹ç›®ç»“æ„

```
src/main/java/org/example/ragtest/
â”œâ”€â”€ loader/                          # æ–‡æ¡£åŠ è½½å™¨åŒ…ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ DocumentLoaderStrategy.java  # ç­–ç•¥æ¥å£
â”‚   â”œâ”€â”€ DocumentLoaderType.java      # ç±»å‹æšä¸¾
â”‚   â”œâ”€â”€ DocumentLoaderFactory.java   # å·¥å‚ç±»
â”‚   â””â”€â”€ impl/                        # ç­–ç•¥å®ç°
â”‚       â”œâ”€â”€ FileSystemDocumentLoaderStrategy.java
â”‚       â”œâ”€â”€ UrlDocumentLoaderStrategy.java
â”‚       â””â”€â”€ ClasspathDocumentLoaderStrategy.java
â”œâ”€â”€ service/
â”‚   â””â”€â”€ DocumentService.java         # é‡æ„åçš„æœåŠ¡ç±»
â””â”€â”€ controller/
    â””â”€â”€ RagController.java           # æ§åˆ¶å™¨
```

---

## æ€»ç»“

é€šè¿‡å¼•å…¥ç­–ç•¥æ¨¡å¼å’Œå·¥å‚æ¨¡å¼ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **ä»£ç æ›´ç®€æ´**: `DocumentService` ä» 200+ è¡Œç¼©å‡åˆ° 150 è¡Œ
2. **èŒè´£æ›´æ¸…æ™°**: æ¯ä¸ªç±»éƒ½æœ‰æ˜ç¡®çš„å•ä¸€èŒè´£
3. **æ‰©å±•æ›´å®¹æ˜“**: æ·»åŠ æ–°åŠ è½½å™¨æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
4. **æµ‹è¯•æ›´ç®€å•**: æ¯ä¸ªç»„ä»¶å¯ä»¥ç‹¬ç«‹æµ‹è¯•
5. **ç»´æŠ¤æ›´æ–¹ä¾¿**: ä¿®æ”¹æŸä¸ªåŠ è½½å™¨ä¸å½±å“å…¶ä»–éƒ¨åˆ†

è¿™æ˜¯ä¸€ä¸ªä¼˜ç§€çš„**é¢å‘å¯¹è±¡è®¾è®¡**å®è·µæ¡ˆä¾‹ï¼Œéµå¾ªäº† SOLID åŸåˆ™ï¼Œä½¿ä»£ç æ›´åŠ ä¸“ä¸šå’Œå·¥ä¸šçº§ã€‚
