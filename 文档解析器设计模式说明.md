# æ–‡æ¡£è§£æå™¨è®¾è®¡æ¨¡å¼è¯´æ˜

## é‡æ„æ¦‚è¿°

åœ¨æ–‡æ¡£åŠ è½½å™¨é‡æ„çš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥ä½¿ç”¨**ç­–ç•¥æ¨¡å¼**å’Œ**å·¥å‚æ¨¡å¼**é‡æ„äº†æ–‡æ¡£è§£æå™¨åŠŸèƒ½ï¼Œå®ç°äº†è§£æå™¨çš„æ™ºèƒ½é€‰æ‹©å’Œè§£è€¦ã€‚

---

## è®¾è®¡æ¨¡å¼åº”ç”¨

### ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**å®ç°**:
- **ç­–ç•¥æ¥å£**: `DocumentParserStrategy`
- **å…·ä½“ç­–ç•¥**:
  - `TextDocumentParserStrategy` - æ–‡æœ¬è§£æç­–ç•¥ï¼ˆTXT, HTML, MDç­‰ï¼‰
  - `PdfDocumentParserStrategy` - PDFè§£æç­–ç•¥
  - `MarkdownDocumentParserStrategy` - Markdownè§£æç­–ç•¥ï¼ˆå¯é€‰ï¼‰

### å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

**å®ç°**:
- **å·¥å‚ç±»**: `DocumentParserFactory`
- **åŠŸèƒ½**: 
  - æ ¹æ® `DocumentParserType` æšä¸¾è¿”å›å¯¹åº”çš„è§£æå™¨
  - **æ™ºèƒ½é€‰æ‹©**: æ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„è§£æå™¨

---

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        FileSystemDocumentLoaderStrategy             â”‚
â”‚  (æ–‡ä»¶ç³»ç»ŸåŠ è½½å™¨ - ä½¿ç”¨è§£æå™¨å·¥å‚)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           DocumentParserFactory                      â”‚
â”‚  â€¢ æ ¹æ®æ–‡ä»¶æ‰©å±•åæ™ºèƒ½é€‰æ‹©è§£æå™¨                        â”‚
â”‚  â€¢ Springè‡ªåŠ¨æ³¨å…¥æ‰€æœ‰è§£æå™¨ç­–ç•¥                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Text Parser   â”‚ â”‚PDF Parser    â”‚ â”‚Markdown      â”‚
â”‚Strategy      â”‚ â”‚Strategy      â”‚ â”‚Parser        â”‚
â”‚              â”‚ â”‚              â”‚ â”‚Strategy      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         å®ç° DocumentParserStrategy æ¥å£
```

---

## æ ¸å¿ƒç±»è¯´æ˜

### 1. DocumentParserStrategyï¼ˆç­–ç•¥æ¥å£ï¼‰

```java
public interface DocumentParserStrategy {
    // è§£ææ–‡æ¡£
    Document parse(InputStream inputStream);
    
    // è·å–è§£æå™¨ç±»å‹
    DocumentParserType getParserType();
    
    // åˆ¤æ–­æ˜¯å¦æ”¯æŒè¯¥æ–‡ä»¶æ‰©å±•å
    boolean supports(String fileExtension);
    
    // è·å–è§£æå™¨å®ä¾‹ï¼ˆç”¨äºé›†æˆï¼‰
    Object getParserInstance();
}
```

**èŒè´£**: å®šä¹‰æ–‡æ¡£è§£æçš„ç»Ÿä¸€è¡Œä¸ºè§„èŒƒ

---

### 2. DocumentParserTypeï¼ˆæšä¸¾ï¼‰

```java
public enum DocumentParserType {
    TEXT,          // çº¯æ–‡æœ¬è§£æå™¨
    PDF,           // PDF è§£æå™¨
    MS_OFFICE,     // MS Office è§£æå™¨
    AUTO_DETECT,   // è‡ªåŠ¨æ£€æµ‹è§£æå™¨
    MARKDOWN,      // Markdown è§£æå™¨
    YAML           // YAML è§£æå™¨
}
```

**èŒè´£**: å®šä¹‰æ”¯æŒçš„è§£æå™¨ç±»å‹

---

### 3. å…·ä½“ç­–ç•¥å®ç°

#### TextDocumentParserStrategy
```java
@Component
public class TextDocumentParserStrategy implements DocumentParserStrategy {
    private final TextDocumentParser parser = new TextDocumentParser();
    
    private static final List<String> SUPPORTED_EXTENSIONS = Arrays.asList(
        "txt", "text", "html", "htm", "md", "markdown", "log", "csv", "json", "xml"
    );
    
    @Override
    public boolean supports(String fileExtension) {
        return SUPPORTED_EXTENSIONS.contains(fileExtension.toLowerCase());
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

**ç‰¹æ€§**:
- æ”¯æŒå¤šç§æ–‡æœ¬æ ¼å¼
- æ— éœ€é¢å¤–ä¾èµ–
- ä½œä¸ºé»˜è®¤è§£æå™¨

#### PdfDocumentParserStrategy
```java
@Component
public class PdfDocumentParserStrategy implements DocumentParserStrategy {
    private final ApachePdfBoxDocumentParser parser = new ApachePdfBoxDocumentParser();
    
    private static final List<String> SUPPORTED_EXTENSIONS = Arrays.asList("pdf");
    
    // ... å®ç°
}
```

**ç‰¹æ€§**:
- ä½¿ç”¨ Apache PDFBox è§£æPDF
- å·²åŒ…å«åœ¨é¡¹ç›®ä¾èµ–ä¸­

#### MarkdownDocumentParserStrategyï¼ˆå¯é€‰ï¼‰
```java
@Component
@ConditionalOnClass(name = "dev.langchain4j.data.document.parser.markdown.MarkdownDocumentParser")
public class MarkdownDocumentParserStrategy implements DocumentParserStrategy {
    // ä½¿ç”¨åå°„åŠ è½½ï¼Œé¿å…ç¡¬ä¾èµ–
    // åªæœ‰å½“ä¾èµ–å­˜åœ¨æ—¶æ‰ä¼šåŠ è½½æ­¤ç±»
}
```

**ç‰¹æ€§**:
- æ¡ä»¶åŠ è½½ï¼Œä¸å¼ºåˆ¶ä¾èµ–
- ä½¿ç”¨åå°„å®ç°åŠ¨æ€åŠ è½½
- éœ€è¦æ·»åŠ ä¾èµ–: `langchain4j-document-parser-markdown`

---

### 4. DocumentParserFactoryï¼ˆå·¥å‚ç±»ï¼‰

```java
@Component
@RequiredArgsConstructor
public class DocumentParserFactory {
    private final List<DocumentParserStrategy> parserStrategies;
    
    // æ ¹æ®ç±»å‹è·å–è§£æå™¨
    public DocumentParserStrategy getParser(DocumentParserType parserType) {
        return parserStrategies.stream()
                .filter(strategy -> strategy.getParserType() == parserType)
                .findFirst()
                .orElseThrow(...);
    }
    
    // æ™ºèƒ½é€‰æ‹©ï¼šæ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨é€‰æ‹©è§£æå™¨
    public DocumentParserStrategy getParserByExtension(String fileExtension) {
        return parserStrategies.stream()
                .filter(strategy -> strategy.supports(fileExtension))
                .findFirst()
                .orElseGet(() -> getParser(DocumentParserType.TEXT));
    }
    
    // æ ¹æ®æ–‡ä»¶åè‡ªåŠ¨é€‰æ‹©è§£æå™¨
    public DocumentParserStrategy getParserByFileName(String fileName) {
        String extension = getFileExtension(fileName);
        return getParserByExtension(extension);
    }
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… **æ™ºèƒ½é€‰æ‹©**: æ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„è§£æå™¨
- âœ… **å®¹é”™å¤„ç†**: æœªæ‰¾åˆ°åŒ¹é…è§£æå™¨æ—¶ä½¿ç”¨é»˜è®¤æ–‡æœ¬è§£æå™¨
- âœ… **è‡ªåŠ¨æ”¶é›†**: Springè‡ªåŠ¨æ³¨å…¥æ‰€æœ‰è§£æå™¨ç­–ç•¥

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. è‡ªåŠ¨é€‰æ‹©è§£æå™¨

```java
@Autowired
private DocumentParserFactory parserFactory;

// æ ¹æ®æ–‡ä»¶åè‡ªåŠ¨é€‰æ‹©è§£æå™¨
String fileName = "example.pdf";
DocumentParserStrategy parser = parserFactory.getParserByFileName(fileName);
// è‡ªåŠ¨é€‰æ‹© PdfDocumentParserStrategy

fileName = "document.txt";
parser = parserFactory.getParserByFileName(fileName);
// è‡ªåŠ¨é€‰æ‹© TextDocumentParserStrategy
```

### 2. åœ¨åŠ è½½å™¨ä¸­ä½¿ç”¨

```java
@Component
@RequiredArgsConstructor
public class FileSystemDocumentLoaderStrategy implements DocumentLoaderStrategy {
    private final DocumentParserFactory parserFactory;
    
    @Override
    public Document loadDocument(String sourcePath) {
        // æ™ºèƒ½é€‰æ‹©è§£æå™¨
        DocumentParserStrategy parser = parserFactory.getParserByFileName(sourcePath);
        
        // ä½¿ç”¨é€‰ä¸­çš„è§£æå™¨åŠ è½½æ–‡æ¡£
        return FileSystemDocumentLoader.loadDocument(
            Paths.get(sourcePath), 
            parser.getParserInstance()
        );
    }
}
```

---

## æ”¯æŒçš„æ–‡ä»¶æ ¼å¼

### å½“å‰å·²å®ç°

| è§£æå™¨ç±»å‹ | æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å | ä¾èµ–æ¨¡å— | çŠ¶æ€ |
|----------|---------------|---------|------|
| TEXT | txt, html, htm, md, markdown, log, csv, json, xml | langchain4j | âœ… å·²å®ç° |
| PDF | pdf | langchain4j-document-parser-apache-pdfbox | âœ… å·²å®ç° |
| MS_OFFICE | doc, docx, ppt, pptx, xls, xlsx | langchain4j-document-parser-apache-poi | âœ… å·²å®ç° |
| MARKDOWN | md, markdown | langchain4j-document-parser-markdown | ğŸŸ¡ å¯é€‰ï¼ˆéœ€æ·»åŠ ä¾èµ–ï¼‰|

### å¯æ‰©å±•æ”¯æŒ

| è§£æå™¨ç±»å‹ | æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å | éœ€è¦çš„ä¾èµ–æ¨¡å— |
|----------|---------------|---------------|
| AUTO_DETECT | è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰æ ¼å¼ | langchain4j-document-parser-apache-tika |
| YAML | yaml, yml | langchain4j-document-parser-yaml |

---

## å¦‚ä½•æ·»åŠ æ–°çš„è§£æå™¨

### åœºæ™¯: æ·»åŠ  MS Office æ–‡æ¡£è§£æå™¨

#### æ­¥éª¤1: æ·»åŠ Mavenä¾èµ–
```xml
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-document-parser-apache-poi</artifactId>
    <version>${langchain4j.version}</version>
</dependency>
```

#### æ­¥éª¤2: åˆ›å»ºç­–ç•¥å®ç°
```java
@Component
public class MsOfficeDocumentParserStrategy implements DocumentParserStrategy {
    
    private final ApachePoiDocumentParser parser = new ApachePoiDocumentParser();
    
    private static final List<String> SUPPORTED_EXTENSIONS = Arrays.asList(
        "doc", "docx", "ppt", "pptx", "xls", "xlsx"
    );
    
    @Override
    public Document parse(InputStream inputStream) {
        return parser.parse(inputStream);
    }
    
    @Override
    public DocumentParserType getParserType() {
        return DocumentParserType.MS_OFFICE;
    }
    
    @Override
    public boolean supports(String fileExtension) {
        return SUPPORTED_EXTENSIONS.contains(fileExtension.toLowerCase());
    }
    
    @Override
    public Object getParserInstance() {
        return parser;
    }
}
```

#### æ­¥éª¤3: å®Œæˆï¼
- âœ… Spring è‡ªåŠ¨æ³¨å…¥æ–°ç­–ç•¥
- âœ… å·¥å‚è‡ªåŠ¨è¯†åˆ«æ–°è§£æå™¨
- âœ… æ–‡ä»¶åŠ è½½å™¨è‡ªåŠ¨ä½¿ç”¨
- âœ… æ— éœ€ä¿®æ”¹ä»»ä½•ç°æœ‰ä»£ç 

---

## ä¼˜åŠ¿æ€»ç»“

### 1. **æ™ºèƒ½åŒ–**
- âœ… æ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨é€‰æ‹©è§£æå™¨
- âœ… æ— éœ€æ‰‹åŠ¨åˆ¤æ–­æ–‡ä»¶ç±»å‹
- âœ… é™ä½ä½¿ç”¨å¤æ‚åº¦

### 2. **è§£è€¦**
- âœ… åŠ è½½å™¨ä¸è§£æå™¨å®Œå…¨è§£è€¦
- âœ… è§£æé€»è¾‘ç‹¬ç«‹ç®¡ç†
- âœ… ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™

### 3. **å¯æ‰©å±•æ€§**
- âœ… æ·»åŠ æ–°è§£æå™¨åªéœ€3æ­¥
- âœ… æ”¯æŒæ¡ä»¶åŠ è½½ï¼ˆå¯é€‰ä¾èµ–ï¼‰
- âœ… ä½¿ç”¨åå°„é¿å…ç¡¬ä¾èµ–

### 4. **å®¹é”™æ€§**
- âœ… æœªçŸ¥æ ¼å¼è‡ªåŠ¨å›é€€åˆ°æ–‡æœ¬è§£æå™¨
- âœ… ç¼ºå°‘ä¾èµ–æ—¶ä¸å½±å“å…¶ä»–åŠŸèƒ½
- âœ… æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

### 5. **å¯ç»´æŠ¤æ€§**
- âœ… æ¯ä¸ªè§£æå™¨ç‹¬ç«‹å®ç°
- âœ… æ˜“äºæµ‹è¯•å’Œè°ƒè¯•
- âœ… ä»£ç ç»“æ„æ¸…æ™°

---

## å®Œæ•´æ¶æ„æ€»ç»“

```
ç”¨æˆ·è¯·æ±‚
    â†“
RagController
    â†“
DocumentService
    â†“
DocumentLoaderFactoryï¼ˆåŠ è½½å™¨å·¥å‚ï¼‰
    â†“
FileSystemDocumentLoaderStrategyï¼ˆåŠ è½½å™¨ç­–ç•¥ï¼‰
    â†“
DocumentParserFactoryï¼ˆè§£æå™¨å·¥å‚ï¼‰
    â†“
è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„è§£æå™¨ç­–ç•¥
    â†“
è§£æå¹¶è¿”å›æ–‡æ¡£
```

**ç‰¹ç‚¹**:
- åŒå±‚ç­–ç•¥æ¨¡å¼ï¼ˆåŠ è½½å™¨ + è§£æå™¨ï¼‰
- åŒå±‚å·¥å‚æ¨¡å¼ï¼ˆåŠ è½½å™¨å·¥å‚ + è§£æå™¨å·¥å‚ï¼‰
- å®Œå…¨ç¬¦åˆSOLIDåŸåˆ™
- å·¥ä¸šçº§ä»£ç è®¾è®¡

---

## é¡¹ç›®ç»“æ„

```
src/main/java/org/example/ragtest/
â”œâ”€â”€ loader/                          # æ–‡æ¡£åŠ è½½å™¨åŒ…
â”‚   â”œâ”€â”€ DocumentLoaderStrategy.java
â”‚   â”œâ”€â”€ DocumentLoaderFactory.java
â”‚   â””â”€â”€ impl/
â”‚       â”œâ”€â”€ FileSystemDocumentLoaderStrategy.java  # ä½¿ç”¨è§£æå™¨å·¥å‚
â”‚       â”œâ”€â”€ UrlDocumentLoaderStrategy.java
â”‚       â””â”€â”€ ClasspathDocumentLoaderStrategy.java
â”œâ”€â”€ parser/                          # æ–‡æ¡£è§£æå™¨åŒ…ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ DocumentParserStrategy.java  # è§£æå™¨ç­–ç•¥æ¥å£
â”‚   â”œâ”€â”€ DocumentParserType.java      # è§£æå™¨ç±»å‹æšä¸¾
â”‚   â”œâ”€â”€ DocumentParserFactory.java   # è§£æå™¨å·¥å‚
â”‚   â””â”€â”€ impl/                        # è§£æå™¨ç­–ç•¥å®ç°
â”‚       â”œâ”€â”€ TextDocumentParserStrategy.java
â”‚       â”œâ”€â”€ PdfDocumentParserStrategy.java
â”‚       â””â”€â”€ MarkdownDocumentParserStrategy.java  # å¯é€‰
â””â”€â”€ service/
    â””â”€â”€ DocumentService.java
```

---

## æ€»ç»“

é€šè¿‡å¼•å…¥è§£æå™¨çš„ç­–ç•¥æ¨¡å¼å’Œå·¥å‚æ¨¡å¼ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **æ™ºèƒ½è§£æ**: æ ¹æ®æ–‡ä»¶ç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„è§£æå™¨
2. **å®Œå…¨è§£è€¦**: åŠ è½½å™¨ä¸è§£æå™¨åˆ†ç¦»ï¼ŒèŒè´£æ›´æ¸…æ™°
3. **æ˜“äºæ‰©å±•**: æ·»åŠ æ–°è§£æå™¨åªéœ€å®ç°æ¥å£å¹¶æ·»åŠ ä¾èµ–
4. **æ¡ä»¶åŠ è½½**: æ”¯æŒå¯é€‰ä¾èµ–ï¼Œé¿å…å¼ºåˆ¶å¼•å…¥ä¸éœ€è¦çš„åº“
5. **å®¹é”™æœºåˆ¶**: æœªçŸ¥æ ¼å¼è‡ªåŠ¨ä½¿ç”¨é»˜è®¤è§£æå™¨

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„**å¤šå±‚è®¾è®¡æ¨¡å¼åº”ç”¨**æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨çœŸå®é¡¹ç›®ä¸­ä¼˜é›…åœ°ç»„åˆä½¿ç”¨å¤šç§è®¾è®¡æ¨¡å¼ã€‚
